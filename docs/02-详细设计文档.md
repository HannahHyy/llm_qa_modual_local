# COMBINE_LLM è¯¦ç»†è®¾è®¡æ–‡æ¡£

## ç‰ˆæœ¬ï¼š3.0
## æ›´æ–°æ—¥æœŸï¼š2025-12-26
## æ–‡æ¡£æ€§è´¨ï¼šè¯¦ç»†è®¾è®¡

---

## ğŸ“Œ æ–‡æ¡£è¯´æ˜

æœ¬æ–‡æ¡£åŸºäºå®é™…å®ç°ä»£ç ç¼–å†™ï¼Œæè¿°ç³»ç»Ÿå„å±‚çš„æ ¸å¿ƒç±»è®¾è®¡ã€å…³é”®æ–¹æ³•å’Œæ•°æ®æµè½¬ã€‚

**æœ¬æ–‡æ¡£å›ç­”çš„æ ¸å¿ƒé—®é¢˜**ï¼š
- âœ… å„å±‚æœ‰å“ªäº›æ ¸å¿ƒç±»ï¼Ÿ
- âœ… è¿™äº›ç±»çš„èŒè´£æ˜¯ä»€ä¹ˆï¼Ÿ
- âœ… å…³é”®æ–¹æ³•çš„å¤„ç†é€»è¾‘æ˜¯ä»€ä¹ˆ?
- âœ… ä¸‰ç§æŸ¥è¯¢åœºæ™¯çš„è¯¦ç»†æµç¨‹æ˜¯ä»€ä¹ˆï¼Ÿ
- âœ… æ•°æ®å¦‚ä½•åœ¨å„å±‚ä¹‹é—´æµè½¬ï¼Ÿ

**å‰ç½®é˜…è¯»**ï¼šè¯·å…ˆé˜…è¯»[æ¶æ„è®¾è®¡æ–‡æ¡£](01-æ¶æ„è®¾è®¡æ–‡æ¡£.md)äº†è§£ç³»ç»Ÿæ•´ä½“åˆ†å±‚æ¶æ„

**ç»„ç»‡æ–¹å¼**ï¼šæŒ‰ç…§ä»ä¸Šåˆ°ä¸‹ï¼ˆAPIâ†’Applicationâ†’Domainâ†’Infrastructureâ†’Coreï¼‰çš„é¡ºåºç»„ç»‡

---

## ç›®å½•

1. [APIå±‚è¯¦ç»†è®¾è®¡](#1-apiå±‚è¯¦ç»†è®¾è®¡)
2. [Applicationå±‚è¯¦ç»†è®¾è®¡](#2-applicationå±‚è¯¦ç»†è®¾è®¡)
3. [Domainå±‚è¯¦ç»†è®¾è®¡](#3-domainå±‚è¯¦ç»†è®¾è®¡)
4. [Infrastructureå±‚è¯¦ç»†è®¾è®¡](#4-infrastructureå±‚è¯¦ç»†è®¾è®¡)
5. [Coreå±‚è¯¦ç»†è®¾è®¡](#5-coreå±‚è¯¦ç»†è®¾è®¡)
6. [ä¸‰ç§æŸ¥è¯¢åœºæ™¯è¯¦ç»†æµç¨‹](#6-ä¸‰ç§æŸ¥è¯¢åœºæ™¯è¯¦ç»†æµç¨‹)
7. [æ•°æ®æµè½¬è®¾è®¡](#7-æ•°æ®æµè½¬è®¾è®¡)

---

## 1. APIå±‚è¯¦ç»†è®¾è®¡

### 1.1 æ ¸å¿ƒèŒè´£

APIå±‚ä½œä¸ºç³»ç»Ÿçš„HTTPæ¥å£æš´éœ²å±‚ï¼Œè´Ÿè´£ï¼š
- æ¥æ”¶å¹¶éªŒè¯HTTPè¯·æ±‚å‚æ•°
- é€šè¿‡ä¾èµ–æ³¨å…¥è·å–Applicationå±‚æœåŠ¡
- è°ƒç”¨æœåŠ¡æ–¹æ³•å¹¶è¿”å›å“åº”
- **ä¸åŒ…å«ä»»ä½•ä¸šåŠ¡é€»è¾‘**

### 1.2 å¯¹è¯æ¥å£ï¼ˆapi/v1/chat.pyï¼‰

#### æ ¸å¿ƒç«¯ç‚¹ï¼šPOST /api/v1/chat/stream

**è¯·æ±‚å‚æ•°**ï¼ˆChatRequestï¼‰ï¼š
- user_idï¼ˆå­—ç¬¦ä¸²ï¼Œå¿…å¡«ï¼‰ï¼šç”¨æˆ·å”¯ä¸€æ ‡è¯†
- session_idï¼ˆå­—ç¬¦ä¸²ï¼Œå¿…å¡«ï¼‰ï¼šä¼šè¯ID
- queryï¼ˆå­—ç¬¦ä¸²ï¼Œå¿…å¡«ï¼‰ï¼šç”¨æˆ·æŸ¥è¯¢å†…å®¹
- scene_idï¼ˆæ•´æ•°ï¼Œå¿…å¡«ï¼‰ï¼šæŸ¥è¯¢åœºæ™¯ï¼ˆ1=æ··åˆï¼Œ2=Neo4jï¼Œ3=ESï¼‰

**å“åº”æ ¼å¼**ï¼šSSEæµå¼å“åº”

SSEæ¶ˆæ¯æ ¼å¼ï¼š
```
data: {"message_type": 1, "content": "æ€è€ƒå†…å®¹"}
data: {"message_type": 2, "content": "å›ç­”å†…å®¹"}
data: {"message_type": 3, "content": "çŸ¥è¯†æ¥æº"}
data: {"message_type": 4, "content": "é”™è¯¯ä¿¡æ¯"}
data: [DONE]
```

**message_typeè¯´æ˜**ï¼š
- 1: thinkï¼ˆæ€è€ƒè¿‡ç¨‹ï¼‰
- 2: dataï¼ˆå›ç­”å†…å®¹ï¼‰
- 3: knowledgeï¼ˆçŸ¥è¯†æ¥æºï¼‰
- 4: errorï¼ˆé”™è¯¯ä¿¡æ¯ï¼‰

**å¤„ç†æµç¨‹**ï¼š
1. éªŒè¯è¯·æ±‚å‚æ•°ï¼ˆPydanticè‡ªåŠ¨éªŒè¯ï¼‰
2. é€šè¿‡Dependsæ³¨å…¥LegacyStreamingService
3. è°ƒç”¨streaming_service.stream_chat()
4. è¿”å›StreamingResponseï¼Œè®¾ç½®MIMEç±»å‹ä¸ºtext/event-stream

### 1.3 ä¼šè¯ç®¡ç†æ¥å£ï¼ˆapi/v1/sessions.pyï¼‰

#### 1.3.1 åˆ›å»ºä¼šè¯ï¼šPOST /api/v1/sessions

**è¯·æ±‚å‚æ•°**ï¼ˆCreateSessionRequestï¼‰ï¼š
- user_idï¼ˆå­—ç¬¦ä¸²ï¼Œå¿…å¡«ï¼‰ï¼šç”¨æˆ·ID
- nameï¼ˆå­—ç¬¦ä¸²ï¼Œå¯é€‰ï¼‰ï¼šä¼šè¯åç§°

**å“åº”**ï¼ˆSessionResponseï¼‰ï¼š
- session_idï¼ˆå­—ç¬¦ä¸²ï¼‰ï¼šæ–°åˆ›å»ºçš„ä¼šè¯ID
- user_idï¼ˆå­—ç¬¦ä¸²ï¼‰ï¼šç”¨æˆ·ID
- nameï¼ˆå­—ç¬¦ä¸²ï¼‰ï¼šä¼šè¯åç§°
- created_atï¼ˆæ—¶é—´æˆ³ï¼‰ï¼šåˆ›å»ºæ—¶é—´

**å¤„ç†æµç¨‹**ï¼š
1. éªŒè¯user_id
2. æ³¨å…¥SessionService
3. è°ƒç”¨session_service.create_session()
4. è¿”å›ä¼šè¯å…ƒæ•°æ®

#### 1.3.2 æŸ¥è¯¢ä¼šè¯åˆ—è¡¨ï¼šGET /api/v1/sessions/{user_id}

**è·¯å¾„å‚æ•°**ï¼š
- user_idï¼ˆå­—ç¬¦ä¸²ï¼‰ï¼šç”¨æˆ·ID

**æŸ¥è¯¢å‚æ•°**ï¼š
- limitï¼ˆæ•´æ•°ï¼Œå¯é€‰ï¼‰ï¼šè¿”å›æ•°é‡é™åˆ¶ï¼Œé»˜è®¤10
- offsetï¼ˆæ•´æ•°ï¼Œå¯é€‰ï¼‰ï¼šåç§»é‡ï¼Œé»˜è®¤0

**å“åº”**ï¼ˆSessionListResponseï¼‰ï¼š
- sessionsï¼ˆåˆ—è¡¨ï¼‰ï¼šä¼šè¯å¯¹è±¡åˆ—è¡¨
- totalï¼ˆæ•´æ•°ï¼‰ï¼šæ€»ä¼šè¯æ•°

**å¤„ç†æµç¨‹**ï¼š
1. éªŒè¯user_id
2. è°ƒç”¨session_service.get_user_sessions()
3. è¿”å›ä¼šè¯åˆ—è¡¨ï¼ˆæŒ‰åˆ›å»ºæ—¶é—´å€’åºï¼‰

#### 1.3.3 åˆ é™¤ä¼šè¯ï¼šDELETE /api/v1/sessions/{session_id}

**è·¯å¾„å‚æ•°**ï¼š
- session_idï¼ˆå­—ç¬¦ä¸²ï¼‰ï¼šä¼šè¯ID

**å“åº”**ï¼š
- successï¼ˆå¸ƒå°”å€¼ï¼‰ï¼šæ˜¯å¦åˆ é™¤æˆåŠŸ

**å¤„ç†æµç¨‹**ï¼š
1. éªŒè¯session_id
2. è°ƒç”¨session_service.delete_session()
3. åŒæ—¶åˆ é™¤Redisã€MySQLã€ESä¸­çš„ä¼šè¯æ•°æ®
4. è¿”å›åˆ é™¤ç»“æœ

### 1.4 å¥åº·æ£€æŸ¥æ¥å£ï¼ˆapi/v1/health.pyï¼‰

#### æ ¸å¿ƒç«¯ç‚¹ï¼šGET /api/v1/health

**å“åº”**ï¼ˆHealthResponseï¼‰ï¼š
- statusï¼ˆå­—ç¬¦ä¸²ï¼‰ï¼š"healthy"æˆ–"unhealthy"
- componentsï¼ˆå­—å…¸ï¼‰ï¼šå„ç»„ä»¶å¥åº·çŠ¶æ€
  - redisï¼ˆå­—ç¬¦ä¸²ï¼‰ï¼š"ok"æˆ–"error"
  - mysqlï¼ˆå­—ç¬¦ä¸²ï¼‰ï¼š"ok"æˆ–"error"
  - elasticsearchï¼ˆå­—ç¬¦ä¸²ï¼‰ï¼š"ok"æˆ–"error"
  - neo4jï¼ˆå­—ç¬¦ä¸²ï¼‰ï¼š"ok"æˆ–"error"
  - llmï¼ˆå­—ç¬¦ä¸²ï¼‰ï¼š"ok"æˆ–"error"

**å¤„ç†æµç¨‹**ï¼š
1. æ³¨å…¥HealthService
2. è°ƒç”¨health_service.check_all()
3. å¹¶å‘æ£€æŸ¥æ‰€æœ‰å¤–éƒ¨æœåŠ¡è¿æ¥çŠ¶æ€
4. è¿”å›æ±‡æ€»ç»“æœ

### 1.5 ä¾èµ–æ³¨å…¥é…ç½®ï¼ˆapi/app_dependencies.pyï¼‰

**æ ¸å¿ƒå‡½æ•°**ï¼š

**get_streaming_service()**ï¼š
- åˆ›å»ºå¹¶è¿”å›LegacyStreamingServiceå®ä¾‹
- æ³¨å…¥æ‰€æœ‰å¿…è¦çš„ä¾èµ–ï¼ˆllm_clientã€es_clientã€repositoriesç­‰ï¼‰

**get_session_service()**ï¼š
- åˆ›å»ºå¹¶è¿”å›SessionServiceå®ä¾‹
- æ³¨å…¥SessionRepository

**get_health_service()**ï¼š
- åˆ›å»ºå¹¶è¿”å›HealthServiceå®ä¾‹
- æ³¨å…¥æ‰€æœ‰Clientä»¥ä¾¿å¥åº·æ£€æŸ¥

**è®¾è®¡è¦ç‚¹**ï¼š
- æ‰€æœ‰æœåŠ¡é‡‡ç”¨å•ä¾‹æ¨¡å¼ï¼ˆé€šè¿‡lru_cacheå®ç°ï¼‰
- ä¾èµ–å…³ç³»æ¸…æ™°ï¼Œä¾¿äºæµ‹è¯•æ—¶Mock
- æŒ‰éœ€åˆ›å»ºï¼Œé¿å…ä¸å¿…è¦çš„èµ„æºæ¶ˆè€—

---

## 2. Applicationå±‚è¯¦ç»†è®¾è®¡

### 2.1 æ ¸å¿ƒèŒè´£

Applicationå±‚è´Ÿè´£ä¸šåŠ¡æµç¨‹ç¼–æ’ï¼Œåè°ƒDomainå±‚å’ŒInfrastructureå±‚çš„æœåŠ¡å®Œæˆå®Œæ•´ä¸šåŠ¡æµç¨‹ã€‚

**å…³é”®åŸåˆ™**ï¼š
- åªåšç¼–æ’ï¼Œä¸å®ç°ä¸šåŠ¡é€»è¾‘
- å®šä¹‰äº‹åŠ¡è¾¹ç•Œ
- å¼‚å¸¸è½¬æ¢å’Œé”™è¯¯å¤„ç†

### 2.2 æµå¼å¯¹è¯æœåŠ¡ï¼ˆapplication/services/legacy_streaming_service.pyï¼‰

#### ç±»åï¼šLegacyStreamingService

è¿™æ˜¯ç³»ç»Ÿçš„**æ ¸å¿ƒæœåŠ¡**ï¼Œå®ç°ä¸‰ç§æŸ¥è¯¢åœºæ™¯çš„å®Œæ•´æµç¨‹ç¼–æ’ã€‚

**ä¾èµ–æ³¨å…¥**ï¼ˆé€šè¿‡æ„é€ å‡½æ•°ï¼‰ï¼š
- llm_clientï¼ˆLLMClientï¼‰ï¼šLLMè°ƒç”¨å®¢æˆ·ç«¯
- es_clientï¼ˆESClientï¼‰ï¼šElasticsearchå®¢æˆ·ç«¯
- message_repoï¼ˆMessageRepositoryï¼‰ï¼šæ¶ˆæ¯å­˜å‚¨
- session_repoï¼ˆSessionRepositoryï¼‰ï¼šä¼šè¯å­˜å‚¨
- neo4j_serviceï¼ˆNeo4jQueryServiceï¼‰ï¼šNeo4jæŸ¥è¯¢æœåŠ¡
- intent_routerï¼ˆLLMIntentRouterï¼‰ï¼šæ„å›¾è·¯ç”±ç­–ç•¥
- knowledge_matcherï¼ˆKnowledgeMatcherServiceï¼‰ï¼šçŸ¥è¯†åŒ¹é…æœåŠ¡
- prompt_builderï¼ˆPromptBuilderServiceï¼‰ï¼šPromptæ„å»ºæœåŠ¡
- formatterï¼ˆMessageFormatterServiceï¼‰ï¼šæ¶ˆæ¯æ ¼å¼åŒ–æœåŠ¡

#### æ ¸å¿ƒæ–¹æ³•ï¼šstream_chat()

**æ–¹æ³•ç­¾å**ï¼š
```
async def stream_chat(
    user_id: str,
    session_id: str,
    query: str,
    scene_id: int
) -> AsyncGenerator[str, None]
```

**å‚æ•°è¯´æ˜**ï¼š
- user_idï¼šç”¨æˆ·æ ‡è¯†
- session_idï¼šä¼šè¯æ ‡è¯†
- queryï¼šç”¨æˆ·æŸ¥è¯¢
- scene_idï¼šåœºæ™¯æ¨¡å¼ï¼ˆ1=æ··åˆï¼Œ2=Neo4jï¼Œ3=ESï¼‰

**è¿”å›**ï¼šå¼‚æ­¥ç”Ÿæˆå™¨ï¼Œé€å—yield SSEæ ¼å¼çš„æ¶ˆæ¯

**æ ¸å¿ƒé€»è¾‘**ï¼š
1. åŠ è½½å†å²æ¶ˆæ¯ï¼ˆè°ƒç”¨message_repo.get_messages()ï¼‰
2. æ ¹æ®scene_idè·¯ç”±åˆ°ä¸åŒå¤„ç†åˆ†æ”¯ï¼š
   - scene_id == 1ï¼šæ··åˆæŸ¥è¯¢æµç¨‹ï¼ˆ_hybrid_stream_genï¼‰
   - scene_id == 2ï¼šNeo4jæŸ¥è¯¢æµç¨‹ï¼ˆ_neo4j_stream_genï¼‰
   - scene_id == 3ï¼šESæŸ¥è¯¢æµç¨‹ï¼ˆ_es_stream_genï¼‰
3. å¼‚æ­¥æµå¼è¿”å›ç»“æœ
4. å­˜å‚¨å¯¹è¯æ¶ˆæ¯ï¼ˆè°ƒç”¨message_repo.append_message()ï¼‰

#### ç§æœ‰æ–¹æ³•ï¼š_es_stream_gen()

**èŒè´£**ï¼šçº¯ESæŸ¥è¯¢åœºæ™¯çš„æµç¨‹ç¼–æ’

**è¯¦ç»†æ­¥éª¤**ï¼š

æ­¥éª¤1ï¼šæ ‡å‡†åŒ–è¯†åˆ«
- è°ƒç”¨æ—§ç³»ç»Ÿçš„æ ‡å‡†è¯†åˆ«ç®—æ³•
- ä»ç”¨æˆ·queryä¸­æå–æ ‡å‡†ç¼–å·å’Œæ ‡å‡†åç§°

æ­¥éª¤2ï¼šESæ··åˆæ£€ç´¢
- æ„å»ºBM25æŸ¥è¯¢ï¼ˆåŸºäºæ ‡å‡†åç§°ï¼‰
- æ„å»ºå‘é‡æŸ¥è¯¢ï¼ˆåŸºäºquery embeddingï¼‰
- ç»„åˆä¸ºhybrid_search
- è°ƒç”¨es_client.search()ï¼Œè¿”å›Top-Kæ–‡æ¡£

æ­¥éª¤3ï¼šçŸ¥è¯†åŒ¹é…
- å°†æ£€ç´¢åˆ°çš„çŸ¥è¯†åˆ—è¡¨ä¼ ç»™knowledge_matcher
- ä½¿ç”¨BM25ç®—æ³•è®¡ç®—queryä¸æ¯æ¡çŸ¥è¯†çš„ç›¸ä¼¼åº¦
- é€‰æ‹©Top-3æœ€ç›¸å…³çŸ¥è¯†

æ­¥éª¤4ï¼šæ„å»ºPrompt
- è°ƒç”¨prompt_builder.build_es_prompt()
- æ‹¼æ¥ï¼šç³»ç»Ÿæç¤ºè¯ + å†å²æ¶ˆæ¯ + çŸ¥è¯†ä¸Šä¸‹æ–‡ + ç”¨æˆ·query

æ­¥éª¤5ï¼šLLMæµå¼ç”Ÿæˆ
- è°ƒç”¨llm_client.async_stream_chat()
- é€Tokenè¿”å›ç”Ÿæˆå†…å®¹

æ­¥éª¤6ï¼šæ ‡ç­¾è¿‡æ»¤ä¸æ ¼å¼åŒ–
- è¿‡æ»¤`<think>`æ ‡ç­¾ï¼ˆé˜²æ­¢é‡å¤è¾“å‡ºæ€è€ƒè¿‡ç¨‹ï¼‰
- è°ƒç”¨formatter.format_sse_message()æ ¼å¼åŒ–ä¸ºSSE
- yieldè¿”å›

æ­¥éª¤7ï¼šå­˜å‚¨æ¶ˆæ¯
- å°†ç”¨æˆ·queryå­˜å‚¨åˆ°message_repo
- å°†åŠ©æ‰‹å›ç­”å­˜å‚¨åˆ°message_repo

#### ç§æœ‰æ–¹æ³•ï¼š_neo4j_stream_gen()

**èŒè´£**ï¼šçº¯Neo4jæŸ¥è¯¢åœºæ™¯çš„æµç¨‹ç¼–æ’

**è¯¦ç»†æ­¥éª¤**ï¼š

æ­¥éª¤1ï¼šè°ƒç”¨Neo4jæŸ¥è¯¢æœåŠ¡
- ç›´æ¥è°ƒç”¨neo4j_service.query_stream()
- è¯¥æœåŠ¡å†…éƒ¨å°è£…äº†æ—§ç³»ç»Ÿçš„Neo4jæŸ¥è¯¢ç®—æ³•

æ­¥éª¤2ï¼šæµå¼è¿”å›
- é€chunkæ¥æ”¶Neo4jæœåŠ¡çš„è¿”å›
- ç›´æ¥yieldï¼ˆNeo4jæœåŠ¡å·²å®Œæˆæ ¼å¼åŒ–ï¼‰

æ­¥éª¤3ï¼šå­˜å‚¨æ¶ˆæ¯
- å­˜å‚¨ç”¨æˆ·queryå’ŒåŠ©æ‰‹å›ç­”

**å…³é”®ç‚¹**ï¼š
- Neo4jæŸ¥è¯¢æµç¨‹å®Œå…¨å¤ç”¨æ—§ç³»ç»ŸéªŒè¯è¿‡çš„ç®—æ³•
- é€šè¿‡é€‚é…å™¨æ¨¡å¼å°è£…ï¼Œå¯¹å¤–æä¾›å¼‚æ­¥æµå¼æ¥å£

#### ç§æœ‰æ–¹æ³•ï¼š_hybrid_stream_gen()

**èŒè´£**ï¼šæ··åˆæŸ¥è¯¢åœºæ™¯çš„æµç¨‹ç¼–æ’

**è¯¦ç»†æ­¥éª¤**ï¼š

æ­¥éª¤1ï¼šæ„å›¾è·¯ç”±
- è°ƒç”¨intent_router.route()
- LLMåˆ¤æ–­ç”¨æˆ·queryéœ€è¦å“ªç§çŸ¥è¯†æº
- è¿”å›è·¯ç”±å†³ç­–ï¼š"neo4j" / "es" / "none"

æ­¥éª¤2ï¼šæ ¹æ®è·¯ç”±å†³ç­–æ‰§è¡Œ
- å¦‚æœå†³ç­–ä¸º"neo4j"ï¼š
  - è°ƒç”¨_neo4j_stream_gen()
  - **å…³é”®**ï¼šè¿‡æ»¤`<think>`æ ‡ç­¾ï¼Œé˜²æ­¢é‡å¤è¾“å‡º
- å¦‚æœå†³ç­–ä¸º"es"ï¼š
  - è°ƒç”¨_es_stream_gen()
- å¦‚æœå†³ç­–ä¸º"none"ï¼š
  - è°ƒç”¨_es_stream_gen()
  - **å…³é”®**ï¼šè¿‡æ»¤ç‰¹å®šçš„é‡å¤thinkæ ‡ç­¾

æ­¥éª¤3ï¼šå­˜å‚¨æ¶ˆæ¯

**å…³é”®è®¾è®¡ç‚¹**ï¼š

**thinkæ ‡ç­¾è¿‡æ»¤é€»è¾‘**ï¼ˆ100%å¤åˆ¶è‡ªæ—§ç³»ç»Ÿï¼‰ï¼š
```
åŸå› ï¼š
- æ„å›¾è·¯ç”±é˜¶æ®µLLMå·²è¾“å‡ºä¸€æ¬¡æ€è€ƒè¿‡ç¨‹
- åç»­æŸ¥è¯¢é˜¶æ®µLLMå¯èƒ½å†æ¬¡è¾“å‡ºæ€è€ƒè¿‡ç¨‹
- éœ€è¦é¿å…ç”¨æˆ·çœ‹åˆ°é‡å¤çš„<think>å†…å®¹

å®ç°æ–¹å¼ï¼š
- ç»´æŠ¤in_think_blockçŠ¶æ€å˜é‡
- æ£€æµ‹åˆ°<think>æ ‡ç­¾ï¼šè®¾ç½®in_think_block=Trueï¼Œè·³è¿‡è¾“å‡º
- æ£€æµ‹åˆ°</think>æ ‡ç­¾ï¼šè®¾ç½®in_think_block=Falseï¼Œè·³è¿‡è¾“å‡º
- in_think_blockä¸ºTrueæ—¶ï¼šè·³è¿‡æ‰€æœ‰å†…å®¹
```

### 2.3 ä¼šè¯ç®¡ç†æœåŠ¡ï¼ˆapplication/services/session_service.pyï¼‰

#### ç±»åï¼šSessionService

**ä¾èµ–æ³¨å…¥**ï¼š
- session_repoï¼ˆSessionRepositoryï¼‰ï¼šä¼šè¯æ•°æ®è®¿é—®

#### æ ¸å¿ƒæ–¹æ³•

**create_session()**ï¼š
- ç”ŸæˆUUIDä½œä¸ºsession_id
- è°ƒç”¨session_repo.create_session()
- ä¸‰å±‚å†™å…¥ï¼šRedis + MySQL + ES
- è¿”å›ä¼šè¯å…ƒæ•°æ®

**get_user_sessions()**ï¼š
- è°ƒç”¨session_repo.get_user_sessions()
- æŸ¥è¯¢é¡ºåºï¼šRedis â†’ MySQL â†’ å›å¡«Redis
- è¿”å›ç”¨æˆ·æ‰€æœ‰ä¼šè¯åˆ—è¡¨

**delete_session()**ï¼š
- è°ƒç”¨session_repo.delete_session()
- åŒæ—¶åˆ é™¤ä¸‰å±‚å­˜å‚¨
- è°ƒç”¨message_repo.delete_messages()åˆ é™¤ä¼šè¯æ¶ˆæ¯

**get_session()**ï¼š
- æ ¹æ®session_idæŸ¥è¯¢å•ä¸ªä¼šè¯
- è¿”å›ä¼šè¯å…ƒæ•°æ®

### 2.4 æ¶ˆæ¯ç®¡ç†æœåŠ¡ï¼ˆapplication/services/message_service.pyï¼‰

#### ç±»åï¼šMessageService

**ä¾èµ–æ³¨å…¥**ï¼š
- message_repoï¼ˆMessageRepositoryï¼‰ï¼šæ¶ˆæ¯æ•°æ®è®¿é—®

#### æ ¸å¿ƒæ–¹æ³•

**get_messages()**ï¼š
- è°ƒç”¨message_repo.get_messages()
- æŸ¥è¯¢é¡ºåºï¼šRedis â†’ ES â†’ å›å¡«Redis
- è¿”å›å†å²æ¶ˆæ¯åˆ—è¡¨

**append_message()**ï¼š
- è°ƒç”¨message_repo.append_message()
- åŒå±‚å†™å…¥ï¼šRedis + ES
- Rediså†™å…¥å¤±è´¥ä¸å½±å“ES

### 2.5 å¥åº·æ£€æŸ¥æœåŠ¡ï¼ˆapplication/services/health_service.pyï¼‰

#### ç±»åï¼šHealthService

**ä¾èµ–æ³¨å…¥**ï¼š
- æ‰€æœ‰Clientï¼ˆllm_clientã€es_clientã€redis_clientç­‰ï¼‰

#### æ ¸å¿ƒæ–¹æ³•

**check_all()**ï¼š
- å¹¶å‘è°ƒç”¨å„Clientçš„health_check()æ–¹æ³•
- æ±‡æ€»ç»“æœ
- è¿”å›æ•´ä½“å¥åº·çŠ¶æ€

---

## 3. Domainå±‚è¯¦ç»†è®¾è®¡

### 3.1 æ ¸å¿ƒèŒè´£

Domainå±‚æ˜¯ç³»ç»Ÿçš„æ ¸å¿ƒä¸šåŠ¡é€»è¾‘å±‚ï¼ŒåŒ…å«ï¼š
- é¢†åŸŸæœåŠ¡ï¼ˆç®—æ³•å®ç°ï¼‰
- ç­–ç•¥æ¨¡å¼ï¼ˆè·¯ç”±å†³ç­–ï¼‰
- é¢†åŸŸæ¨¡å‹ï¼ˆæ•°æ®å®ä½“ï¼‰

**å…³é”®åŸåˆ™**ï¼š
- çº¯ä¸šåŠ¡é€»è¾‘ï¼Œä¸ä¾èµ–æ¡†æ¶
- å¯ç‹¬ç«‹å•å…ƒæµ‹è¯•
- ç®—æ³•100%ä¸€è‡´æ€§ï¼ˆä¸æ—§ç³»ç»Ÿï¼‰

### 3.2 Neo4jæŸ¥è¯¢æœåŠ¡ï¼ˆdomain/services/neo4j_query_service.pyï¼‰

#### ç±»åï¼šNeo4jQueryService

**è®¾è®¡ç›®çš„**ï¼šå°è£…æ—§ç³»ç»Ÿçš„Neo4jæŸ¥è¯¢ç®—æ³•ï¼Œä¿è¯è¾“å‡ºä¸€è‡´æ€§

**ä¾èµ–æ³¨å…¥**ï¼š
- llm_clientï¼ˆLLMClientï¼‰ï¼šç”¨äºè¾…åŠ©æŸ¥è¯¢

**æ ¸å¿ƒæ–¹æ³•ï¼šquery_stream()**

**å®ç°æ–¹å¼**ï¼š
```
1. é€šè¿‡sys.pathå¯¼å…¥æ—§ç³»ç»Ÿæ¨¡å—ï¼š
   from neo4j_code.apps.views_intent.views_new import LLM as Neo4jLLM

2. åˆ›å»ºæ—§ç³»ç»ŸLLMå®ä¾‹ï¼š
   self.neo4j_llm = Neo4jLLM()

3. è°ƒç”¨æ—§ç³»ç»Ÿçš„å¼‚æ­¥æµå¼æ–¹æ³•ï¼š
   async for chunk in self.neo4j_llm.generate_answer_async(question, history_msgs):
       yield chunk
```

**å…³é”®è®¾è®¡ç‚¹**ï¼š
- **é€‚é…å™¨æ¨¡å¼**ï¼šå°†æ—§ç³»ç»Ÿæ¥å£é€‚é…ä¸ºæ–°æ¶æ„
- **ç®—æ³•å¤ç”¨**ï¼šç›´æ¥è°ƒç”¨æ—§ä»£ç ï¼Œä¿è¯100%ä¸€è‡´æ€§
- **å¼‚æ­¥æµå¼**ï¼šæä¾›async generatoræ¥å£

**æ—§ç³»ç»Ÿç®—æ³•æµç¨‹**ï¼ˆå·²éªŒè¯ï¼‰ï¼š
1. æ ‡å‡†åŒ–è¯†åˆ«ï¼ˆæå–æ ‡å‡†ç¼–å·å’Œåç§°ï¼‰
2. ESæ£€ç´¢æ ‡å‡†æ–‡æœ¬ï¼ˆè·å–ç›¸å…³æ ‡å‡†å†…å®¹ï¼‰
3. ä½¿ç”¨æ£€ç´¢åˆ°çš„æ ‡å‡†ä½œä¸ºç¤ºä¾‹
4. LLMç”ŸæˆCypheræŸ¥è¯¢è¯­å¥
5. æ‰§è¡ŒCypheræŸ¥è¯¢Neo4j
6. æ ¼å¼åŒ–æŸ¥è¯¢ç»“æœ
7. LLMåŸºäºç»“æœç”Ÿæˆæœ€ç»ˆå›ç­”

### 3.3 çŸ¥è¯†åŒ¹é…æœåŠ¡ï¼ˆdomain/services/knowledge_matcher_service.pyï¼‰

#### ç±»åï¼šKnowledgeMatcherService

**è®¾è®¡ç›®çš„**ï¼šä½¿ç”¨BM25ç®—æ³•åŒ¹é…LLMè¾“å‡ºä¸æ£€ç´¢åˆ°çš„çŸ¥è¯†ï¼Œé€‰æ‹©æœ€ç›¸å…³çš„çŸ¥è¯†

**ä¾èµ–æ³¨å…¥**ï¼š
- llm_clientï¼ˆLLMClientï¼‰ï¼šæš‚æœªä½¿ç”¨ï¼Œé¢„ç•™æ‰©å±•

**æ ¸å¿ƒæ–¹æ³•ï¼šmatch_knowledge()**

**æ–¹æ³•ç­¾å**ï¼š
```
def match_knowledge(
    llm_output: str,
    knowledge_list: List[Knowledge],
    top_k: int = 3
) -> List[Knowledge]
```

**ç®—æ³•æ­¥éª¤**ï¼ˆ100%å¤åˆ¶è‡ªæ—§ç³»ç»Ÿserver2.py:450-520ï¼‰ï¼š

æ­¥éª¤1ï¼šæ–‡æœ¬é¢„å¤„ç†
- å¯¹llm_outputå’Œæ¯æ¡knowledge.contentè¿›è¡Œåˆ†è¯
- ä½¿ç”¨jiebaåˆ†è¯åº“

æ­¥éª¤2ï¼šè®¡ç®—TFï¼ˆè¯é¢‘ï¼‰
- ç»Ÿè®¡æ¯ä¸ªè¯åœ¨æ–‡æ¡£ä¸­å‡ºç°çš„æ¬¡æ•°
- è®¡ç®—è¯é¢‘ï¼šTF = è¯å‡ºç°æ¬¡æ•° / æ–‡æ¡£æ€»è¯æ•°

æ­¥éª¤3ï¼šè®¡ç®—IDFï¼ˆé€†æ–‡æ¡£é¢‘ç‡ï¼‰
- IDF = log(æ–‡æ¡£æ€»æ•° / åŒ…å«è¯¥è¯çš„æ–‡æ¡£æ•°)

æ­¥éª¤4ï¼šè®¡ç®—BM25åˆ†æ•°
- ä½¿ç”¨BM25å…¬å¼ï¼š
  ```
  BM25 = Î£(IDF(qi) * (f(qi, D) * (k1 + 1)) / (f(qi, D) + k1 * (1 - b + b * |D| / avgdl)))

  å…¶ä¸­ï¼š
  - qiï¼šæŸ¥è¯¢ä¸­çš„ç¬¬iä¸ªè¯
  - f(qi, D)ï¼šè¯qiåœ¨æ–‡æ¡£Dä¸­çš„é¢‘ç‡
  - |D|ï¼šæ–‡æ¡£Dçš„é•¿åº¦
  - avgdlï¼šæ‰€æœ‰æ–‡æ¡£çš„å¹³å‡é•¿åº¦
  - k1 = 1.5ï¼ˆè°ƒèŠ‚å› å­ï¼‰
  - b = 0.75ï¼ˆé•¿åº¦å½’ä¸€åŒ–å› å­ï¼‰
  ```

æ­¥éª¤5ï¼šæ’åºå’Œæˆªå–
- æŒ‰BM25åˆ†æ•°é™åºæ’åº
- è¿”å›Top-KçŸ¥è¯†

**å…³é”®å‚æ•°**ï¼š
- k1 = 1.5ï¼šæ§åˆ¶è¯é¢‘é¥±å’Œåº¦
- b = 0.75ï¼šæ§åˆ¶æ–‡æ¡£é•¿åº¦å½’ä¸€åŒ–ç¨‹åº¦

### 3.4 Promptæ„å»ºæœåŠ¡ï¼ˆdomain/services/prompt_builder_service.pyï¼‰

#### ç±»åï¼šPromptBuilderService

**è®¾è®¡ç›®çš„**ï¼šæ ¹æ®ä¸åŒåœºæ™¯æ„å»ºLLMçš„è¾“å…¥Prompt

**ä¾èµ–æ³¨å…¥**ï¼šæ— ï¼ˆçº¯å‡½æ•°é€»è¾‘ï¼‰

**æ ¸å¿ƒæ–¹æ³•**ï¼š

**build_es_prompt()**ï¼š
- åœºæ™¯ï¼šESæŸ¥è¯¢
- å‚æ•°ï¼šqueryã€history_msgsã€knowledge_list
- è¿”å›ï¼šå®Œæ•´çš„Promptå­—ç¬¦ä¸²
- é€»è¾‘ï¼š
  ```
  ç³»ç»Ÿæç¤ºè¯
  + å†å²æ¶ˆæ¯ï¼ˆæ ¼å¼åŒ–ä¸º"user: xxx\nassistant: xxx"ï¼‰
  + çŸ¥è¯†ä¸Šä¸‹æ–‡ï¼ˆæ ¼å¼åŒ–ä¸º"çŸ¥è¯†1ï¼šxxx\nçŸ¥è¯†2ï¼šxxx"ï¼‰
  + å½“å‰ç”¨æˆ·query
  ```

**build_neo4j_prompt()**ï¼š
- åœºæ™¯ï¼šNeo4jæŸ¥è¯¢
- é€»è¾‘ç±»ä¼¼ï¼Œä½†ç³»ç»Ÿæç¤ºè¯å¼ºè°ƒå›¾æ•°æ®åº“æŸ¥è¯¢

**build_hybrid_prompt()**ï¼š
- åœºæ™¯ï¼šæ··åˆæŸ¥è¯¢
- é€»è¾‘ï¼šç»„åˆESå’ŒNeo4jçš„Promptæ¨¡æ¿

**format_history_messages()**ï¼š
- å°†Messageå¯¹è±¡åˆ—è¡¨æ ¼å¼åŒ–ä¸ºå­—ç¬¦ä¸²
- é™åˆ¶å†å²æ¶ˆæ¯æ•°é‡ï¼ˆé¿å…è¶…è¿‡LLMä¸Šä¸‹æ–‡é•¿åº¦ï¼‰

**format_knowledge_context()**ï¼š
- å°†Knowledgeå¯¹è±¡åˆ—è¡¨æ ¼å¼åŒ–ä¸ºå­—ç¬¦ä¸²
- æŒ‰ç›¸å…³æ€§åˆ†æ•°æ’åº
- æ·»åŠ åºå·å’Œæ¥æºæ ‡æ³¨

### 3.5 æ¶ˆæ¯æ ¼å¼åŒ–æœåŠ¡ï¼ˆdomain/services/message_formatter_service.pyï¼‰

#### ç±»åï¼šMessageFormatterService

**è®¾è®¡ç›®çš„**ï¼šå°†å„ç§å†…å®¹æ ¼å¼åŒ–ä¸ºSSEæ¶ˆæ¯æ ¼å¼

**æ ¸å¿ƒæ–¹æ³•**ï¼š

**format_sse_message()**ï¼š
- å‚æ•°ï¼šmessage_typeã€content
- è¿”å›ï¼šSSEæ ¼å¼å­—ç¬¦ä¸²
- æ ¼å¼ï¼š`data: {"message_type": X, "content": "xxx"}\n\n`

**format_done_message()**ï¼š
- è¿”å›ï¼š`data: [DONE]\n\n`

**format_error_message()**ï¼š
- å‚æ•°ï¼šerror_msg
- è¿”å›ï¼šmessage_type=4çš„SSEæ¶ˆæ¯

### 3.6 æ„å›¾è·¯ç”±ç­–ç•¥ï¼ˆdomain/strategies/llm_intent_router.pyï¼‰

#### ç±»åï¼šLLMIntentRouter

**è®¾è®¡ç›®çš„**ï¼šä½¿ç”¨LLMåˆ¤æ–­ç”¨æˆ·æŸ¥è¯¢åº”è¯¥è·¯ç”±åˆ°å“ªä¸ªçŸ¥è¯†æº

**ä¾èµ–æ³¨å…¥**ï¼š
- llm_clientï¼ˆLLMClientï¼‰ï¼šç”¨äºè°ƒç”¨LLMè¿›è¡Œåˆ¤æ–­

**æ ¸å¿ƒæ–¹æ³•ï¼šroute()**

**æ–¹æ³•ç­¾å**ï¼š
```
async def route(
    user_query: str,
    history_msgs: List[Message],
    stream_callback: Optional[Callable] = None
) -> str
```

**å‚æ•°è¯´æ˜**ï¼š
- user_queryï¼šç”¨æˆ·æŸ¥è¯¢
- history_msgsï¼šå†å²æ¶ˆæ¯
- stream_callbackï¼šå¯é€‰çš„æµå¼å›è°ƒå‡½æ•°

**è¿”å›**ï¼šè·¯ç”±å†³ç­–å­—ç¬¦ä¸²ï¼ˆ"neo4j" / "es" / "none"ï¼‰

**å¤„ç†æµç¨‹**ï¼š

æ­¥éª¤1ï¼šæ„å»ºè·¯ç”±Prompt
- ä»é…ç½®ä¸­è·å–get_llm_router_prompt()
- PromptåŒ…å«ï¼š
  - ç³»ç»Ÿè¯´æ˜ï¼ˆä½ æ˜¯æ„å›¾è·¯ç”±å™¨ï¼‰
  - ä»»åŠ¡æè¿°ï¼ˆåˆ¤æ–­æŸ¥è¯¢ç±»å‹ï¼‰
  - è¾“å‡ºæ ¼å¼è¦æ±‚ï¼ˆåªè¾“å‡ºneo4j/es/noneï¼‰

æ­¥éª¤2ï¼šè°ƒç”¨LLM
- ä½¿ç”¨async_stream_chat()
- modelã€max_tokensã€temperatureä»é…ç½®è¯»å–
- é€Tokenæ¥æ”¶LLMè¾“å‡º

æ­¥éª¤3ï¼šè§£æå†³ç­–
- æå–LLMè¾“å‡ºä¸­çš„å…³é”®è¯
- åŒ¹é…"neo4j"ã€"es"ã€"none"
- é»˜è®¤è¿”å›"es"

æ­¥éª¤4ï¼šæµå¼å›è°ƒ
- å¦‚æœæä¾›äº†stream_callback
- å°†LLMçš„æ€è€ƒè¿‡ç¨‹é€šè¿‡callbackè¿”å›ç»™ä¸Šå±‚
- ç”¨äºå‘ç”¨æˆ·å±•ç¤ºè·¯ç”±å†³ç­–æ€è€ƒ

**å…³é”®é…ç½®å‚æ•°**ï¼ˆåœ¨core/config/prompts.pyä¸­ï¼‰ï¼š
- router_modelï¼šè·¯ç”±ä½¿ç”¨çš„LLMæ¨¡å‹
- router_max_tokensï¼šæœ€å¤§Tokenæ•°
- router_temperatureï¼šé‡‡æ ·æ¸©åº¦
- llm_router_promptï¼šè·¯ç”±Promptæ¨¡æ¿

### 3.7 é¢†åŸŸæ¨¡å‹

#### Messageæ¨¡å‹ï¼ˆdomain/models/message.pyï¼‰

**èŒè´£**ï¼šè¡¨ç¤ºä¸€æ¡å¯¹è¯æ¶ˆæ¯

**å­—æ®µ**ï¼š
- roleï¼ˆå­—ç¬¦ä¸²ï¼‰ï¼šè§’è‰²ï¼ˆ"user"æˆ–"assistant"ï¼‰
- contentï¼ˆå­—ç¬¦ä¸²ï¼‰ï¼šæ¶ˆæ¯å†…å®¹
- timestampï¼ˆdatetimeï¼‰ï¼šæ—¶é—´æˆ³

**æ–¹æ³•**ï¼š
- is_user()ï¼šåˆ¤æ–­æ˜¯å¦ä¸ºç”¨æˆ·æ¶ˆæ¯
- is_assistant()ï¼šåˆ¤æ–­æ˜¯å¦ä¸ºåŠ©æ‰‹æ¶ˆæ¯
- to_dict()ï¼šè½¬æ¢ä¸ºå­—å…¸
- from_dict()ï¼šä»å­—å…¸åˆ›å»º

#### Knowledgeæ¨¡å‹ï¼ˆdomain/models/knowledge.pyï¼‰

**èŒè´£**ï¼šè¡¨ç¤ºä¸€æ¡æ£€ç´¢åˆ°çš„çŸ¥è¯†

**å­—æ®µ**ï¼š
- contentï¼ˆå­—ç¬¦ä¸²ï¼‰ï¼šçŸ¥è¯†å†…å®¹
- sourceï¼ˆå­—ç¬¦ä¸²ï¼‰ï¼šæ¥æºï¼ˆ"elasticsearch" / "neo4j"ï¼‰
- scoreï¼ˆæµ®ç‚¹æ•°ï¼‰ï¼šç›¸å…³æ€§åˆ†æ•°ï¼ˆ0-1ï¼‰
- metadataï¼ˆå­—å…¸ï¼‰ï¼šå…ƒæ•°æ®
- titleï¼ˆå­—ç¬¦ä¸²ï¼Œå¯é€‰ï¼‰ï¼šçŸ¥è¯†æ ‡é¢˜
- doc_idï¼ˆå­—ç¬¦ä¸²ï¼Œå¯é€‰ï¼‰ï¼šæ–‡æ¡£ID

**æ–¹æ³•**ï¼š
- is_from_es()ï¼šæ˜¯å¦æ¥è‡ªES
- is_from_neo4j()ï¼šæ˜¯å¦æ¥è‡ªNeo4j
- is_relevant(threshold)ï¼šæ˜¯å¦è¾¾åˆ°ç›¸å…³æ€§é˜ˆå€¼
- from_es_hit()ï¼šä»ES hitå¯¹è±¡åˆ›å»ºKnowledge
- from_neo4j_record()ï¼šä»Neo4jè®°å½•åˆ›å»ºKnowledge

**from_es_hit()è¯¦ç»†é€»è¾‘**ï¼š
```
1. æå–ESè¿”å›çš„_sourceå­—æ®µ
2. æå–ESçš„_scoreå­—æ®µï¼ˆåŸå§‹åˆ†æ•°ï¼‰
3. å½’ä¸€åŒ–scoreåˆ°0-1èŒƒå›´ï¼š
   ä½¿ç”¨Sigmoidå‡½æ•°ï¼šscore = 1 / (1 + exp(-raw_score / 10))
4. åˆ›å»ºKnowledgeå¯¹è±¡ï¼Œå¡«å……æ‰€æœ‰å­—æ®µ
5. åœ¨metadataä¸­ä¿å­˜raw_scoreï¼ˆåŸå§‹åˆ†æ•°ï¼‰
```

#### Intentæ¨¡å‹ï¼ˆdomain/models/intent.pyï¼‰

**èŒè´£**ï¼šè¡¨ç¤ºä»ç”¨æˆ·æŸ¥è¯¢ä¸­è¯†åˆ«å‡ºçš„æ„å›¾

**å­—æ®µ**ï¼š
- intent_typeï¼ˆæšä¸¾ï¼‰ï¼šæ„å›¾ç±»å‹ï¼ˆES_QUERY / NEO4J_QUERY / HYBRID_QUERYï¼‰
- confidenceï¼ˆæµ®ç‚¹æ•°ï¼‰ï¼šç½®ä¿¡åº¦ï¼ˆ0-1ï¼‰
- queryï¼ˆå­—ç¬¦ä¸²ï¼‰ï¼šåŸå§‹æŸ¥è¯¢
- parsed_queryï¼ˆå­—ç¬¦ä¸²ï¼Œå¯é€‰ï¼‰ï¼šè§£æåçš„æŸ¥è¯¢
- metadataï¼ˆå­—å…¸ï¼‰ï¼šé¢å¤–å…ƒæ•°æ®

**æ–¹æ³•**ï¼š
- is_es_query()ï¼šæ˜¯å¦ä¸ºESæŸ¥è¯¢
- is_neo4j_query()ï¼šæ˜¯å¦ä¸ºNeo4jæŸ¥è¯¢
- is_hybrid_query()ï¼šæ˜¯å¦ä¸ºæ··åˆæŸ¥è¯¢
- is_confident(threshold)ï¼šæ˜¯å¦è¾¾åˆ°ç½®ä¿¡åº¦é˜ˆå€¼

---

## 4. Infrastructureå±‚è¯¦ç»†è®¾è®¡

### 4.1 æ ¸å¿ƒèŒè´£

Infrastructureå±‚è´Ÿè´£å°è£…æ‰€æœ‰å¤–éƒ¨ç³»ç»Ÿäº¤äº’ï¼Œæä¾›ç»Ÿä¸€æ¥å£ã€‚

**å…³é”®åŸåˆ™**ï¼š
- å¯æ›¿æ¢æ€§
- å®¹é”™è®¾è®¡
- è¿æ¥æ± ç®¡ç†

### 4.2 LLMå®¢æˆ·ç«¯ï¼ˆinfrastructure/clients/llm_client.pyï¼‰

#### ç±»åï¼šLLMClient

**èŒè´£**ï¼šå°è£…LLM APIè°ƒç”¨ï¼Œæä¾›4ç§è°ƒç”¨æ¨¡å¼

**æ„é€ å‡½æ•°å‚æ•°**ï¼š
- base_urlï¼šLLM APIåœ°å€
- api_keyï¼šAPIå¯†é’¥
- modelï¼šæ¨¡å‹åç§°
- max_tokensï¼šæœ€å¤§Tokenæ•°
- temperatureï¼šé‡‡æ ·æ¸©åº¦

**å››ç§è°ƒç”¨æ¨¡å¼**ï¼ˆ100%åŒ¹é…æ—§ç³»ç»Ÿï¼‰ï¼š

**1. sync_nonstream_chat()**ï¼š
- åŒæ­¥éæµå¼è°ƒç”¨
- ç­‰å¾…å®Œæ•´å“åº”åè¿”å›
- ä½¿ç”¨requestsåº“å‘é€HTTP POST
- è¿”å›ï¼šå®Œæ•´çš„å›ç­”å­—ç¬¦ä¸²

**2. sync_stream_chat()**ï¼š
- åŒæ­¥æµå¼è°ƒç”¨
- ä½¿ç”¨Generatoré€å—è¿”å›
- è§£æSSEæ ¼å¼å“åº”æµ
- yieldæ¯ä¸ªToken

**3. async_nonstream_chat()**ï¼š
- å¼‚æ­¥éæµå¼è°ƒç”¨
- ä½¿ç”¨asyncioå’Œaiohttp
- ç­‰å¾…å®Œæ•´å“åº”
- è¿”å›ï¼šå®Œæ•´çš„å›ç­”å­—ç¬¦ä¸²

**4. async_stream_chat()**ï¼š
- å¼‚æ­¥æµå¼è°ƒç”¨
- ä½¿ç”¨AsyncGeneratoré€å—è¿”å›
- è§£æSSEæ ¼å¼å“åº”æµ
- yieldæ¯ä¸ªToken

**æ ¸å¿ƒå®ç°ç»†èŠ‚**ï¼š

**è¯·æ±‚æ„é€ **ï¼š
```
POST {base_url}/v1/chat/completions
Headers:
  Authorization: Bearer {api_key}
  Content-Type: application/json
Body:
  {
    "model": "{model}",
    "messages": [
      {"role": "system", "content": "..."},
      {"role": "user", "content": "..."}
    ],
    "max_tokens": {max_tokens},
    "temperature": {temperature},
    "stream": true/false
  }
```

**SSEè§£æé€»è¾‘**ï¼š
```
1. æŒ‰è¡Œè¯»å–å“åº”æµ
2. æ£€æµ‹"data: "å‰ç¼€
3. è·³è¿‡"data: [DONE]"
4. è§£æJSONï¼šjson.loads(line[6:])
5. æå–choices[0].delta.content
6. yield content
```

**é”™è¯¯å¤„ç†**ï¼š
- ç½‘ç»œé”™è¯¯ï¼šé‡è¯•æœ€å¤š3æ¬¡
- HTTPé”™è¯¯ï¼šè®°å½•é”™è¯¯ç å’Œå“åº”
- è§£æé”™è¯¯ï¼šè·³è¿‡å½“å‰chunkï¼Œç»§ç»­å¤„ç†

### 4.3 Elasticsearchå®¢æˆ·ç«¯ï¼ˆinfrastructure/clients/es_client.pyï¼‰

#### ç±»åï¼šESClient

**èŒè´£**ï¼šå°è£…Elasticsearchæ“ä½œ

**æ„é€ å‡½æ•°å‚æ•°**ï¼š
- hostã€portï¼šESåœ°å€
- usernameã€passwordï¼šè®¤è¯ä¿¡æ¯
- request_timeoutï¼šè¶…æ—¶æ—¶é—´

**æ ¸å¿ƒæ–¹æ³•**ï¼š

**connect()**ï¼š
- å»ºç«‹ESè¿æ¥
- **å…³é”®ç®—æ³•**ï¼šä»£ç†ç»•è¿‡
  ```
  åŸå› ï¼šESé€šå¸¸åœ¨å†…ç½‘ï¼Œéœ€è¦ç»•è¿‡HTTP_PROXY

  æ­¥éª¤ï¼š
  1. ä¿å­˜å½“å‰ç¯å¢ƒå˜é‡ï¼šHTTP_PROXYã€HTTPS_PROXYã€http_proxyã€https_proxy
  2. ä¸´æ—¶åˆ é™¤è¿™äº›ç¯å¢ƒå˜é‡
  3. ä½¿ç”¨requestså‘é€å¥åº·æ£€æŸ¥è¯·æ±‚
  4. æ¢å¤ç¯å¢ƒå˜é‡
  ```

**search()**ï¼š
- æ‰§è¡ŒESæŸ¥è¯¢
- å‚æ•°ï¼šindexã€query_dslã€size
- è¿”å›ï¼šhitsåˆ—è¡¨
- æ”¯æŒï¼šboolæŸ¥è¯¢ã€matchæŸ¥è¯¢ã€vectoræŸ¥è¯¢

**hybrid_search()**ï¼š
- æ··åˆæ£€ç´¢ï¼ˆBM25 + å‘é‡ï¼‰
- å‚æ•°ï¼šindexã€text_queryã€vector_queryã€size
- é€»è¾‘ï¼š
  ```
  1. æ„å»ºboolæŸ¥è¯¢ï¼š
     {
       "bool": {
         "should": [
           {"match": {"content": text_query}},  // BM25
           {"knn": {"vector": vector_query}}     // å‘é‡
         ]
       }
     }
  2. è°ƒç”¨search()
  3. è¿”å›èåˆç»“æœ
  ```

**index_document()**ï¼š
- ç´¢å¼•æ–‡æ¡£
- å‚æ•°ï¼šindexã€doc_idã€document
- æ”¯æŒï¼šè‡ªåŠ¨åˆ›å»ºç´¢å¼•ã€æ–‡æ¡£æ›´æ–°

**delete_document()**ï¼š
- åˆ é™¤æ–‡æ¡£
- å‚æ•°ï¼šindexã€doc_id

**health_check()**ï¼š
- æ£€æŸ¥ESé›†ç¾¤å¥åº·çŠ¶æ€
- è¿”å›ï¼šå¸ƒå°”å€¼

### 4.4 Rediså®¢æˆ·ç«¯ï¼ˆinfrastructure/clients/redis_client.pyï¼‰

#### ç±»åï¼šRedisClient

**èŒè´£**ï¼šå°è£…Redisæ“ä½œ

**æ„é€ å‡½æ•°å‚æ•°**ï¼š
- hostã€portã€dbï¼šRedisè¿æ¥å‚æ•°
- passwordï¼šè®¤è¯å¯†ç 

**æ ¸å¿ƒæ–¹æ³•**ï¼ˆå…¨éƒ¨æ˜¯å¼‚æ­¥æ–¹æ³•ï¼‰ï¼š

**lrange()**ï¼š
- è¯»å–åˆ—è¡¨
- ç”¨äºï¼šè·å–å†å²æ¶ˆæ¯

**rpush()**ï¼š
- è¿½åŠ åˆ°åˆ—è¡¨å°¾éƒ¨
- ç”¨äºï¼šå­˜å‚¨æ–°æ¶ˆæ¯

**expire()**ï¼š
- è®¾ç½®è¿‡æœŸæ—¶é—´
- ç”¨äºï¼šæ¶ˆæ¯è‡ªåŠ¨è¿‡æœŸï¼ˆ24å°æ—¶ï¼‰

**hset() / hgetall()**ï¼š
- Hashæ“ä½œ
- ç”¨äºï¼šä¼šè¯å…ƒæ•°æ®å­˜å‚¨

**delete()**ï¼š
- åˆ é™¤é”®
- ç”¨äºï¼šåˆ é™¤ä¼šè¯æ•°æ®

**ping()**ï¼š
- å¥åº·æ£€æŸ¥
- è¿”å›ï¼šå¸ƒå°”å€¼

### 4.5 MySQLå®¢æˆ·ç«¯ï¼ˆinfrastructure/clients/mysql_client.pyï¼‰

#### ç±»åï¼šMySQLClient

**èŒè´£**ï¼šå°è£…MySQLæ•°æ®åº“æ“ä½œ

**æ„é€ å‡½æ•°å‚æ•°**ï¼š
- hostã€portã€userã€passwordã€database

**æ ¸å¿ƒæ–¹æ³•**ï¼š

**connect()**ï¼š
- å»ºç«‹æ•°æ®åº“è¿æ¥
- ä½¿ç”¨è¿æ¥æ± ï¼ˆpool_size=10ï¼‰

**execute_query()**ï¼š
- æ‰§è¡ŒæŸ¥è¯¢
- å‚æ•°ï¼šsqlã€params
- è¿”å›ï¼šæŸ¥è¯¢ç»“æœåˆ—è¡¨

**execute_update()**ï¼š
- æ‰§è¡Œæ›´æ–°/æ’å…¥/åˆ é™¤
- å‚æ•°ï¼šsqlã€params
- è¿”å›ï¼šå½±å“è¡Œæ•°

**health_check()**ï¼š
- æ‰§è¡Œ`SELECT 1`æ£€æŸ¥è¿æ¥
- è¿”å›ï¼šå¸ƒå°”å€¼

### 4.6 æ¶ˆæ¯ä»“å‚¨ï¼ˆinfrastructure/repositories/message_repository.pyï¼‰

#### ç±»åï¼šMessageRepository

**èŒè´£**ï¼šå°è£…æ¶ˆæ¯çš„åŒå±‚å­˜å‚¨é€»è¾‘ï¼ˆRedis + ESï¼‰

**ä¾èµ–æ³¨å…¥**ï¼š
- redis_clientï¼ˆRedisClientï¼‰
- es_clientï¼ˆESClientï¼‰

**æ ¸å¿ƒæ–¹æ³•**ï¼š

**get_messages()**ï¼š

**æ–¹æ³•ç­¾å**ï¼š
```
async def get_messages(
    user_id: str,
    session_id: str,
    limit: int = 50
) -> List[Message]
```

**è¯¦ç»†æµç¨‹**ï¼š
```
æ­¥éª¤1ï¼šæ„å»ºRedis key
key = f"messages:{user_id}:{session_id}"

æ­¥éª¤2ï¼šå°è¯•ä»Redisè¯»å–
items = await redis_client.lrange(key, 0, -1)

æ­¥éª¤3ï¼šRediså‘½ä¸­
if items:
  - ååºåˆ—åŒ–JSONä¸ºMessageå¯¹è±¡
  - è¿”å›æ¶ˆæ¯åˆ—è¡¨

æ­¥éª¤4ï¼šRedisæœªå‘½ä¸­ï¼ŒæŸ¥è¯¢ES
messages = await _get_messages_from_es(user_id, session_id)

æ­¥éª¤5ï¼šå›å¡«Redis
if messages:
  - åºåˆ—åŒ–ä¸ºJSON
  - await redis_client.rpush(key, json_list)
  - await redis_client.expire(key, 86400)  # 24å°æ—¶

æ­¥éª¤6ï¼šè¿”å›æ¶ˆæ¯åˆ—è¡¨
```

**append_message()**ï¼š

**æ–¹æ³•ç­¾å**ï¼š
```
async def append_message(
    user_id: str,
    session_id: str,
    role: str,
    content: str
) -> Message
```

**è¯¦ç»†æµç¨‹**ï¼š
```
æ­¥éª¤1ï¼šåˆ›å»ºMessageå¯¹è±¡
message = Message(role=role, content=content, timestamp=now())

æ­¥éª¤2ï¼šåŒæ­¥å†™å…¥Redis
key = f"messages:{user_id}:{session_id}"
await redis_client.rpush(key, message.to_json())
await redis_client.expire(key, 86400)

æ­¥éª¤3ï¼šå¼‚æ­¥å†™å…¥ESï¼ˆå®¹é”™ï¼‰
try:
  es_client.index_document(
    index="messages",
    doc_id=f"{user_id}_{session_id}_{timestamp}",
    document=message.to_dict()
  )
except Exception as e:
  logger.warning(f"ESå†™å…¥å¤±è´¥ï¼ˆéè‡´å‘½ï¼‰: {e}")
  # â—ä¸æŠ›å‡ºå¼‚å¸¸ï¼ŒRediså†™å…¥æˆåŠŸå³å¯

æ­¥éª¤4ï¼šè¿”å›æ¶ˆæ¯å¯¹è±¡
```

**å…³é”®è®¾è®¡ç‚¹**ï¼š
- Redisä¸ºä¸»ç¼“å­˜ï¼ŒESä¸ºæŒä¹…åŒ–å¤‡ä»½
- Rediså†™å…¥å¤±è´¥æ‰æŠ›å¼‚å¸¸ï¼ŒESå†™å…¥å¤±è´¥åªè®°å½•æ—¥å¿—
- 24å°æ—¶è‡ªåŠ¨è¿‡æœŸç­–ç•¥

### 4.7 ä¼šè¯ä»“å‚¨ï¼ˆinfrastructure/repositories/session_repository.pyï¼‰

#### ç±»åï¼šSessionRepository

**èŒè´£**ï¼šå°è£…ä¼šè¯çš„ä¸‰å±‚å­˜å‚¨é€»è¾‘ï¼ˆRedis + MySQL + ESï¼‰

**ä¾èµ–æ³¨å…¥**ï¼š
- redis_clientï¼ˆRedisClientï¼‰
- mysql_clientï¼ˆMySQLClientï¼‰
- es_clientï¼ˆESClientï¼‰

**æ ¸å¿ƒæ–¹æ³•**ï¼š

**create_session()**ï¼š

**è¯¦ç»†æµç¨‹**ï¼š
```
æ­¥éª¤1ï¼šå†™å…¥MySQLï¼ˆä¸»å­˜å‚¨ï¼‰
sql = "INSERT INTO sessions (session_id, user_id, name, created_at) VALUES (%s, %s, %s, %s)"
mysql_client.execute_update(sql, [session_id, user_id, name, now()])

æ­¥éª¤2ï¼šå†™å…¥Redisï¼ˆç¼“å­˜ï¼‰
key = f"sessions:{user_id}"
session_meta = {
  "session_id": session_id,
  "name": name,
  "created_at": timestamp
}
await redis_client.hset(key, session_id, json.dumps(session_meta))

æ­¥éª¤3ï¼šå†™å…¥ESï¼ˆæ£€ç´¢ï¼Œå®¹é”™ï¼‰
try:
  es_client.index_document(
    index="sessions",
    doc_id=session_id,
    document=session_meta
  )
except Exception as e:
  logger.warning(f"ESå†™å…¥å¤±è´¥ï¼ˆéè‡´å‘½ï¼‰: {e}")

æ­¥éª¤4ï¼šè¿”å›ä¼šè¯å…ƒæ•°æ®
```

**get_user_sessions()**ï¼š

**è¯¦ç»†æµç¨‹**ï¼š
```
æ­¥éª¤1ï¼šæ„å»ºRedis key
key = f"sessions:{user_id}"

æ­¥éª¤2ï¼šå°è¯•ä»Redisè¯»å–
sessions_dict = await redis_client.hgetall(key)

æ­¥éª¤3ï¼šRediså‘½ä¸­
if sessions_dict:
  - ååºåˆ—åŒ–ä¸ºä¼šè¯åˆ—è¡¨
  - æŒ‰created_atå€’åºæ’åº
  - è¿”å›

æ­¥éª¤4ï¼šRedisæœªå‘½ä¸­ï¼ŒæŸ¥è¯¢MySQL
sql = "SELECT * FROM sessions WHERE user_id = %s ORDER BY created_at DESC"
rows = mysql_client.execute_query(sql, [user_id])

æ­¥éª¤5ï¼šå›å¡«Redis
for row in rows:
  await redis_client.hset(key, row['session_id'], json.dumps(row))

æ­¥éª¤6ï¼šè¿”å›ä¼šè¯åˆ—è¡¨
```

**delete_session()**ï¼š

**è¯¦ç»†æµç¨‹**ï¼š
```
æ­¥éª¤1ï¼šåˆ é™¤MySQL
sql = "DELETE FROM sessions WHERE session_id = %s"
mysql_client.execute_update(sql, [session_id])

æ­¥éª¤2ï¼šåˆ é™¤Redis
await redis_client.hdel(f"sessions:{user_id}", session_id)

æ­¥éª¤3ï¼šåˆ é™¤ESï¼ˆå®¹é”™ï¼‰
try:
  es_client.delete_document("sessions", session_id)
except Exception as e:
  logger.warning(f"ESåˆ é™¤å¤±è´¥ï¼ˆéè‡´å‘½ï¼‰: {e}")
```

**å…³é”®è®¾è®¡ç‚¹**ï¼š
- MySQLä¸ºä¸»å­˜å‚¨ï¼ˆäº‹åŠ¡ä¿è¯ï¼‰
- Redisä¸ºç¼“å­˜ï¼ˆå¿«é€ŸæŸ¥è¯¢ï¼‰
- ESä¸ºæ£€ç´¢å’Œåˆ†æï¼ˆå¤±è´¥å¯å®¹å¿ï¼‰
- ä¸‰å±‚æ•°æ®æœ€ç»ˆä¸€è‡´æ€§

---

## 5. Coreå±‚è¯¦ç»†è®¾è®¡

### 5.1 é…ç½®ç®¡ç†ï¼ˆcore/config/ï¼‰

#### settings.py - ç³»ç»Ÿé…ç½®

**æ ¸å¿ƒç±»**ï¼šSettingsï¼ˆç»§æ‰¿Pydantic BaseSettingsï¼‰

**é…ç½®é¡¹åˆ†ç»„**ï¼š
- Redisé…ç½®ï¼šhostã€portã€dbã€password
- MySQLé…ç½®ï¼šhostã€portã€userã€passwordã€database
- Elasticsearché…ç½®ï¼šhostã€portã€usernameã€passwordã€knowledge_indexã€conversation_index
- Neo4jé…ç½®ï¼šuriã€userã€password
- LLMé…ç½®ï¼šbase_urlã€api_keyã€modelã€max_tokensã€temperature
- Embeddingé…ç½®ï¼šhostã€portã€url
- Langfuseé…ç½®ï¼šenabledã€public_keyã€secret_key

**é…ç½®åŠ è½½æ–¹å¼**ï¼š
```
1. è¯»å–.envæ–‡ä»¶
2. ç¯å¢ƒå˜é‡è¦†ç›–.env
3. PydanticéªŒè¯ç±»å‹å’Œå¿…å¡«é¡¹
4. å•ä¾‹æ¨¡å¼ï¼Œå…¨å±€å”¯ä¸€Settingså®ä¾‹
```

#### prompts.py - æç¤ºè¯å’ŒLLMå‚æ•°é…ç½®

**æ ¸å¿ƒç±»**ï¼šPromptSettingsï¼ˆç»§æ‰¿Pydantic BaseSettingsï¼‰

**ä¸¤å±‚é…ç½®æ¶æ„**ï¼š
```
ç¬¬ä¸€å±‚ï¼šä»£ç ä¸­çš„é»˜è®¤å€¼
class PromptSettings(BaseSettings):
    system_prompt: str = Field(
        default="ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ç½‘ç»œå®‰å…¨åŠ©æ‰‹...",
        description="ç³»ç»Ÿæç¤ºè¯"
    )

ç¬¬äºŒå±‚ï¼š.envæ–‡ä»¶è¦†ç›–
PROMPT_SYSTEM_PROMPT="ä½ æ˜¯ç½‘ç»œå®‰å…¨ä¸“å®¶..."

è·å–æ–¹å¼ï¼š
prompt = get_system_prompt()  # è¿”å›.envå€¼æˆ–é»˜è®¤å€¼
```

**32ä¸ªå¯é…ç½®å‚æ•°**ï¼š

**æç¤ºè¯æ¨¡æ¿ï¼ˆ11ä¸ªï¼‰**ï¼š
1. system_promptï¼šç³»ç»Ÿæç¤ºè¯
2. es_query_promptï¼šESæŸ¥è¯¢æç¤ºè¯
3. neo4j_query_promptï¼šNeo4jæŸ¥è¯¢æç¤ºè¯
4. hybrid_query_promptï¼šæ··åˆæŸ¥è¯¢æç¤ºè¯
5. llm_router_promptï¼šæ„å›¾è·¯ç”±æç¤ºè¯
6. knowledge_format_promptï¼šçŸ¥è¯†æ ¼å¼åŒ–æç¤ºè¯
7. standard_recognition_promptï¼šæ ‡å‡†è¯†åˆ«æç¤ºè¯
8. cypher_generation_promptï¼šCypherç”Ÿæˆæç¤ºè¯
9. error_handling_promptï¼šé”™è¯¯å¤„ç†æç¤ºè¯
10. conversation_summary_promptï¼šå¯¹è¯æ€»ç»“æç¤ºè¯
11. knowledge_match_promptï¼šçŸ¥è¯†åŒ¹é…æç¤ºè¯

**LLMå‚æ•°ï¼ˆ21ä¸ªï¼‰**ï¼š
1. default_modelï¼šé»˜è®¤æ¨¡å‹åç§°
2. default_max_tokensï¼šé»˜è®¤æœ€å¤§Tokenæ•°
3. default_temperatureï¼šé»˜è®¤æ¸©åº¦

4-6. es_modelã€es_max_tokensã€es_temperatureï¼šESæŸ¥è¯¢ä¸“ç”¨
7-9. neo4j_modelã€neo4j_max_tokensã€neo4j_temperatureï¼šNeo4jæŸ¥è¯¢ä¸“ç”¨
10-12. hybrid_modelã€hybrid_max_tokensã€hybrid_temperatureï¼šæ··åˆæŸ¥è¯¢ä¸“ç”¨
13-15. router_modelã€router_max_tokensã€router_temperatureï¼šæ„å›¾è·¯ç”±ä¸“ç”¨
16-18. cypher_modelã€cypher_max_tokensã€cypher_temperatureï¼šCypherç”Ÿæˆä¸“ç”¨
19-21. summary_modelã€summary_max_tokensã€summary_temperatureï¼šå¯¹è¯æ€»ç»“ä¸“ç”¨

**è·å–å‡½æ•°**ï¼š
- get_system_prompt()
- get_es_query_prompt()
- get_neo4j_query_prompt()
- ...ï¼ˆæ¯ä¸ªé…ç½®é¡¹éƒ½æœ‰å¯¹åº”çš„getå‡½æ•°ï¼‰

### 5.2 æ—¥å¿—ç®¡ç†ï¼ˆcore/logging.pyï¼‰

**æ ¸å¿ƒå‡½æ•°**ï¼šsetup_logging()

**æ—¥å¿—é…ç½®**ï¼š
- æ—¥å¿—åº“ï¼šloguru
- æ—¥å¿—çº§åˆ«ï¼šINFOï¼ˆç”Ÿäº§ï¼‰/ DEBUGï¼ˆå¼€å‘ï¼‰
- è¾“å‡ºç›®æ ‡ï¼š
  - å¼€å‘ç¯å¢ƒï¼šæ§åˆ¶å°ï¼ˆå¸¦é¢œè‰²ï¼‰
  - ç”Ÿäº§ç¯å¢ƒï¼šæ–‡ä»¶ï¼ˆJSONæ ¼å¼ï¼‰
- æ–‡ä»¶è½®è½¬ï¼š500MBæˆ–æ¯å¤©
- ä¿ç•™æ—¶é—´ï¼š30å¤©
- å‹ç¼©ï¼šzipæ ¼å¼

**æ—¥å¿—æ ¼å¼**ï¼š
```
å¼€å‘ç¯å¢ƒï¼š
{time} | {level} | {name}:{function}:{line} - {message}

ç”Ÿäº§ç¯å¢ƒï¼ˆJSONï¼‰ï¼š
{
  "timestamp": "2025-12-26T10:30:00.123Z",
  "level": "INFO",
  "logger": "app.services.chat",
  "function": "stream_chat",
  "line": 123,
  "message": "å¤„ç†ç”¨æˆ·æŸ¥è¯¢",
  "extra": {...}
}
```

### 5.3 å¼‚å¸¸å¤„ç†ï¼ˆcore/exceptions.pyï¼‰

**å¼‚å¸¸å±‚æ¬¡ç»“æ„**ï¼š
```
BaseAppExceptionï¼ˆåŸºç±»ï¼‰
â”œâ”€â”€ ConfigErrorï¼ˆé…ç½®é”™è¯¯ï¼‰
â”œâ”€â”€ DatabaseErrorï¼ˆæ•°æ®åº“é”™è¯¯ï¼‰
â”‚   â”œâ”€â”€ RedisError
â”‚   â”œâ”€â”€ MySQLError
â”‚   â””â”€â”€ ElasticsearchError
â”œâ”€â”€ LLMClientErrorï¼ˆLLMè°ƒç”¨é”™è¯¯ï¼‰
â”œâ”€â”€ IntentParseErrorï¼ˆæ„å›¾è§£æé”™è¯¯ï¼‰
â””â”€â”€ RetrievalErrorï¼ˆçŸ¥è¯†æ£€ç´¢é”™è¯¯ï¼‰
```

**å¼‚å¸¸å±æ€§**ï¼š
- messageï¼šé”™è¯¯æ¶ˆæ¯
- error_codeï¼šé”™è¯¯ç ï¼ˆå¦‚"DB_001"ï¼‰
- detailsï¼šè¯¦ç»†ä¿¡æ¯ï¼ˆå­—å…¸ï¼‰

**å¼‚å¸¸å¤„ç†æµç¨‹**ï¼š
```
1. ä¸šåŠ¡ä»£ç æŠ›å‡ºè‡ªå®šä¹‰å¼‚å¸¸
2. ExceptionHandlerMiddlewareæ•è·
3. è½¬æ¢ä¸ºHTTPçŠ¶æ€ç å’Œå“åº”
4. è®°å½•é”™è¯¯æ—¥å¿—
5. è¿”å›ç»Ÿä¸€æ ¼å¼çš„é”™è¯¯å“åº”ï¼š
   {
     "error_code": "LLM_001",
     "message": "LLMè°ƒç”¨è¶…æ—¶",
     "details": {...}
   }
```

### 5.4 ä¸­é—´ä»¶ï¼ˆcore/middleware.pyï¼‰

**RequestLoggingMiddleware**ï¼š
- è®°å½•æ¯ä¸ªè¯·æ±‚çš„æ–¹æ³•ã€è·¯å¾„ã€è€—æ—¶ã€çŠ¶æ€ç 
- ä½¿ç”¨logger.infoè®°å½•

**CORSMiddleware**ï¼š
- å¤„ç†è·¨åŸŸè¯·æ±‚
- å…è®¸çš„æºï¼šé…ç½®ä¸­æŒ‡å®š
- å…è®¸çš„æ–¹æ³•ï¼šGETã€POSTã€DELETEã€OPTIONS

---

## 6. ä¸‰ç§æŸ¥è¯¢åœºæ™¯è¯¦ç»†æµç¨‹

### 6.1 åœºæ™¯1ï¼šçº¯ESæŸ¥è¯¢ï¼ˆscene_id=3ï¼‰

**é€‚ç”¨åœºæ™¯**ï¼šæ³•è§„æ ‡å‡†æŸ¥è¯¢

**å®Œæ•´æµç¨‹å›¾**ï¼š
```
ç”¨æˆ·æŸ¥è¯¢
   â†“
APIå±‚ï¼š/api/v1/chat/stream
   â†“ (å‚æ•°éªŒè¯)
Applicationå±‚ï¼šLegacyStreamingService.stream_chat()
   â†“ (åŠ è½½å†å²æ¶ˆæ¯)
   â†“ (scene_id==3ï¼Œè·¯ç”±åˆ°_es_stream_gen)
   â†“
æ­¥éª¤1ï¼šæ ‡å‡†åŒ–è¯†åˆ«
   - è°ƒç”¨æ—§ç³»ç»Ÿç®—æ³•
   - è¾“å…¥ï¼šç”¨æˆ·query
   - è¾“å‡ºï¼šæ ‡å‡†ç¼–å·ã€æ ‡å‡†åç§°
   â†“
æ­¥éª¤2ï¼šESæ··åˆæ£€ç´¢
   - æ„å»ºBM25æŸ¥è¯¢ï¼ˆåŸºäºæ ‡å‡†åç§°ï¼‰
   - æ„å»ºå‘é‡æŸ¥è¯¢ï¼ˆåŸºäºquery embeddingï¼‰
   - è°ƒç”¨es_client.hybrid_search()
   - è¿”å›Top-10æ–‡æ¡£
   â†“
æ­¥éª¤3ï¼šçŸ¥è¯†åŒ¹é…
   - è°ƒç”¨knowledge_matcher.match_knowledge()
   - ä½¿ç”¨BM25ç®—æ³•è®¡ç®—ç›¸ä¼¼åº¦
   - é€‰æ‹©Top-3çŸ¥è¯†
   â†“
æ­¥éª¤4ï¼šæ„å»ºPrompt
   - è°ƒç”¨prompt_builder.build_es_prompt()
   - æ‹¼æ¥ï¼šç³»ç»Ÿæç¤ºè¯ + å†å²æ¶ˆæ¯ + çŸ¥è¯† + query
   â†“
æ­¥éª¤5ï¼šLLMæµå¼ç”Ÿæˆ
   - è°ƒç”¨llm_client.async_stream_chat()
   - é€Tokenè¿”å›
   â†“
æ­¥éª¤6ï¼šè¿‡æ»¤å’Œæ ¼å¼åŒ–
   - è¿‡æ»¤<think>æ ‡ç­¾
   - è°ƒç”¨formatter.format_sse_message()
   - æ ¼å¼åŒ–ä¸ºSSE
   â†“
æ­¥éª¤7ï¼šæµå¼è¿”å›å‰ç«¯
   - yield SSEæ¶ˆæ¯
   â†“
æ­¥éª¤8ï¼šå­˜å‚¨æ¶ˆæ¯
   - è°ƒç”¨message_repo.append_message()
   - Redis + ESåŒå±‚å†™å…¥
   â†“
å®Œæˆ
```

**å…³é”®å‚æ•°**ï¼š
- ESæ£€ç´¢Top-Kï¼š10
- çŸ¥è¯†åŒ¹é…Top-Kï¼š3
- LLM modelï¼šä»é…ç½®è¯»å–es_model
- LLM max_tokensï¼šä»é…ç½®è¯»å–es_max_tokens
- LLM temperatureï¼šä»é…ç½®è¯»å–es_temperature

**æ ‡å‡†åŒ–è¯†åˆ«ç®—æ³•**ï¼ˆå¤åˆ¶è‡ªæ—§ç³»ç»Ÿï¼‰ï¼š
```
è¾“å…¥ï¼šç”¨æˆ·query = "GB/T 22239-2019çš„è¦æ±‚æ˜¯ä»€ä¹ˆ"

æ­¥éª¤1ï¼šæ­£åˆ™åŒ¹é…æ ‡å‡†ç¼–å·
pattern = r'(GB/T|GB|YD/T|YD)\s*[\d\-\.]+'
åŒ¹é…ç»“æœï¼š["GB/T 22239-2019"]

æ­¥éª¤2ï¼šæå–æ ‡å‡†åç§°ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
æŸ¥æ‰¾"æ ‡å‡†"ã€"è§„èŒƒ"ç­‰å…³é”®è¯
æˆ–è€…é€šè¿‡ESæŸ¥è¯¢æ ‡å‡†ç¼–å·è·å–å…¨ç§°

è¾“å‡ºï¼š
{
  "standard_code": "GB/T 22239-2019",
  "standard_name": "ä¿¡æ¯å®‰å…¨æŠ€æœ¯ ç½‘ç»œå®‰å…¨ç­‰çº§ä¿æŠ¤åŸºæœ¬è¦æ±‚"
}
```

**ESæ··åˆæ£€ç´¢Query DSL**ï¼š
```json
{
  "query": {
    "bool": {
      "should": [
        {
          "match": {
            "content": {
              "query": "ä¿¡æ¯å®‰å…¨æŠ€æœ¯ ç½‘ç»œå®‰å…¨ç­‰çº§ä¿æŠ¤åŸºæœ¬è¦æ±‚",
              "boost": 1.0
            }
          }
        },
        {
          "script_score": {
            "query": {"match_all": {}},
            "script": {
              "source": "cosineSimilarity(params.query_vector, 'content_vector') + 1.0",
              "params": {
                "query_vector": [0.1, 0.2, ..., 0.9]
              }
            },
            "boost": 1.0
          }
        }
      ]
    }
  },
  "size": 10
}
```

### 6.2 åœºæ™¯2ï¼šçº¯Neo4jæŸ¥è¯¢ï¼ˆscene_id=2ï¼‰

**é€‚ç”¨åœºæ™¯**ï¼šç½‘ç»œä¸šåŠ¡æƒ…å†µæŸ¥è¯¢

**å®Œæ•´æµç¨‹å›¾**ï¼š
```
ç”¨æˆ·æŸ¥è¯¢
   â†“
APIå±‚ï¼š/api/v1/chat/stream
   â†“
Applicationå±‚ï¼šLegacyStreamingService.stream_chat()
   â†“ (scene_id==2ï¼Œè·¯ç”±åˆ°_neo4j_stream_gen)
   â†“
è°ƒç”¨Neo4jæŸ¥è¯¢æœåŠ¡
   - neo4j_service.query_stream(query, history)
   â†“ (å†…éƒ¨æµç¨‹ï¼Œ100%å¤ç”¨æ—§ç³»ç»Ÿ)
   â†“
æ­¥éª¤1ï¼šæ ‡å‡†åŒ–è¯†åˆ«
   - æå–æ ‡å‡†ç¼–å·å’Œåç§°
   â†“
æ­¥éª¤2ï¼šESæ£€ç´¢æ ‡å‡†æ–‡æœ¬
   - åŸºäºæ ‡å‡†ç¼–å·æŸ¥è¯¢ES
   - è·å–æ ‡å‡†çš„å®Œæ•´å†…å®¹
   â†“
æ­¥éª¤3ï¼šä½¿ç”¨æ ‡å‡†ä½œä¸ºç¤ºä¾‹
   - å°†æ ‡å‡†å†…å®¹ä½œä¸ºfew-shotç¤ºä¾‹
   â†“
æ­¥éª¤4ï¼šLLMç”ŸæˆCypheræŸ¥è¯¢
   - è¾“å…¥ï¼šç”¨æˆ·query + æ ‡å‡†ç¤ºä¾‹
   - è¾“å‡ºï¼šCypheræŸ¥è¯¢è¯­å¥
   â†“
æ­¥éª¤5ï¼šæ‰§è¡ŒCypheræŸ¥è¯¢
   - è°ƒç”¨neo4j_clientæ‰§è¡ŒCypher
   - è·å–å›¾æ•°æ®åº“æŸ¥è¯¢ç»“æœ
   â†“
æ­¥éª¤6ï¼šæ ¼å¼åŒ–ç»“æœ
   - å°†Cypherç»“æœè½¬æ¢ä¸ºè‡ªç„¶è¯­è¨€æè¿°
   â†“
æ­¥éª¤7ï¼šLLMç”Ÿæˆæœ€ç»ˆå›ç­”
   - è¾“å…¥ï¼šæ ¼å¼åŒ–ç»“æœ + ç”¨æˆ·query
   - è¾“å‡ºï¼šæµå¼å›ç­”
   â†“
æµå¼è¿”å›å‰ç«¯
   â†“
å­˜å‚¨æ¶ˆæ¯
   â†“
å®Œæˆ
```

**Cypherç”Ÿæˆç¤ºä¾‹**ï¼š
```
ç”¨æˆ·queryï¼šæŸ¥è¯¢æŸVPNè®¾å¤‡çš„é…ç½®æƒ…å†µ

LLMç”Ÿæˆçš„Cypherï¼š
MATCH (d:Device {name: "VPN-001"})
OPTIONAL MATCH (d)-[:HAS_CONFIG]->(c:Config)
RETURN d.name, d.type, c.config_data, c.last_updated
```

**å…³é”®ç‚¹**ï¼š
- Neo4jæŸ¥è¯¢å®Œå…¨å¤ç”¨æ—§ç³»ç»ŸéªŒè¯è¿‡çš„ç®—æ³•
- é€šè¿‡é€‚é…å™¨æ¨¡å¼å°è£…ï¼Œå¯¹å¤–æä¾›å¼‚æ­¥æµå¼æ¥å£
- æ—§ç³»ç»Ÿä»£ç è·¯å¾„ï¼š`old/neo4j_code/apps/views_intent/views_new.py`

### 6.3 åœºæ™¯3ï¼šæ··åˆæŸ¥è¯¢ï¼ˆscene_id=1ï¼‰

**é€‚ç”¨åœºæ™¯**ï¼šéœ€è¦åŒæ—¶æŸ¥è¯¢ä¸šåŠ¡æƒ…å†µå’Œæ³•è§„è¦æ±‚

**å®Œæ•´æµç¨‹å›¾**ï¼š
```
ç”¨æˆ·æŸ¥è¯¢
   â†“
APIå±‚ï¼š/api/v1/chat/stream
   â†“
Applicationå±‚ï¼šLegacyStreamingService.stream_chat()
   â†“ (scene_id==1ï¼Œè·¯ç”±åˆ°_hybrid_stream_gen)
   â†“
æ­¥éª¤1ï¼šæ„å›¾è·¯ç”±
   - è°ƒç”¨intent_router.route(query, history, stream_callback)
   - LLMåˆ¤æ–­æŸ¥è¯¢ç±»å‹
   - è¿”å›å†³ç­–ï¼š"neo4j" / "es" / "none"
   â†“
æ­¥éª¤2ï¼šæ ¹æ®å†³ç­–åˆ†æ”¯
   â”œâ”€ å†³ç­–="neo4j" â”€â†’ æ‰§è¡ŒNeo4jæŸ¥è¯¢ + è¿‡æ»¤<think>
   â”œâ”€ å†³ç­–="es" â”€â†’ æ‰§è¡ŒESæŸ¥è¯¢
   â””â”€ å†³ç­–="none" â”€â†’ æ‰§è¡ŒESæŸ¥è¯¢ + è¿‡æ»¤ç‰¹å®š<think>
   â†“
æµå¼è¿”å›å‰ç«¯
   â†“
å­˜å‚¨æ¶ˆæ¯
   â†“
å®Œæˆ
```

**æ„å›¾è·¯ç”±Promptç¤ºä¾‹**ï¼š
```
ç³»ç»Ÿï¼šä½ æ˜¯ä¸€ä¸ªæ„å›¾è·¯ç”±å™¨ï¼Œè´Ÿè´£åˆ¤æ–­ç”¨æˆ·æŸ¥è¯¢åº”è¯¥ä½¿ç”¨å“ªç§çŸ¥è¯†æºã€‚

è§„åˆ™ï¼š
- å¦‚æœæŸ¥è¯¢æ¶‰åŠç½‘ç»œè®¾å¤‡ã€é…ç½®ã€ä¸šåŠ¡æƒ…å†µï¼Œè¾“å‡º"neo4j"
- å¦‚æœæŸ¥è¯¢æ¶‰åŠæ³•è§„ã€æ ‡å‡†ã€åˆè§„è¦æ±‚ï¼Œè¾“å‡º"es"
- å¦‚æœæ— æ³•åˆ¤æ–­æˆ–ä¸å±äºä»¥ä¸Šä¸¤ç±»ï¼Œè¾“å‡º"none"

ç”¨æˆ·æŸ¥è¯¢ï¼š{query}

è¯·è¾“å‡ºè·¯ç”±å†³ç­–ï¼ˆåªè¾“å‡ºneo4j/es/noneä¹‹ä¸€ï¼‰ï¼š
```

**LLMè·¯ç”±å†³ç­–ç¤ºä¾‹**ï¼š
```
æŸ¥è¯¢1ï¼š"VPNè®¾å¤‡çš„é…ç½®æƒ…å†µ"
å†³ç­–ï¼šneo4j

æŸ¥è¯¢2ï¼š"GB/T 22239-2019çš„ç­‰çº§ä¿æŠ¤è¦æ±‚"
å†³ç­–ï¼šes

æŸ¥è¯¢3ï¼š"ä»Šå¤©å¤©æ°”æ€ä¹ˆæ ·"
å†³ç­–ï¼šnone
```

**<think>æ ‡ç­¾è¿‡æ»¤é€»è¾‘**ï¼ˆå…³é”®Bugä¿®å¤ç‚¹ï¼‰ï¼š

**ä¸ºä»€ä¹ˆéœ€è¦è¿‡æ»¤**ï¼š
- æ„å›¾è·¯ç”±é˜¶æ®µLLMå·²è¾“å‡ºä¸€æ¬¡æ€è€ƒè¿‡ç¨‹ï¼ˆ<think>...</think>ï¼‰
- åç»­æŸ¥è¯¢é˜¶æ®µLLMå¯èƒ½å†æ¬¡è¾“å‡ºæ€è€ƒè¿‡ç¨‹
- éœ€è¦é¿å…ç”¨æˆ·çœ‹åˆ°é‡å¤çš„æ€è€ƒå†…å®¹

**å®ç°æ–¹å¼**ï¼š
```
çŠ¶æ€æœºï¼š
  in_think_block = False  # åˆå§‹çŠ¶æ€

æµå¼å¤„ç†æ¯ä¸ªchunkï¼š
  if "<think>" in content:
    in_think_block = True
    continue  # è·³è¿‡<think>æ ‡ç­¾æœ¬èº«

  if "</think>" in content:
    in_think_block = False
    continue  # è·³è¿‡</think>æ ‡ç­¾æœ¬èº«

  if in_think_block:
    continue  # è·³è¿‡thinkå—å†…çš„æ‰€æœ‰å†…å®¹

  yield content  # è¾“å‡ºéthinkå†…å®¹
```

**ç‰¹æ®Šè¿‡æ»¤**ï¼ˆelseåˆ†æ”¯ï¼‰ï¼š
```
å½“å†³ç­–ä¸º"none"æ—¶ï¼ŒLLMå¯èƒ½è¾“å‡ºï¼š
"<think>å¼€å§‹å¯¹ç”¨æˆ·çš„æé—®è¿›è¡Œæ·±å…¥è§£æ..."

è¿™æ˜¯ESæŸ¥è¯¢çš„å›ºå®šå¼€å¤´ï¼Œå·²åœ¨æ„å›¾è·¯ç”±é˜¶æ®µè¾“å‡º
éœ€è¦ç‰¹æ®Šè¿‡æ»¤ï¼š

if "<think>å¼€å§‹å¯¹ç”¨æˆ·çš„æé—®è¿›è¡Œæ·±å…¥è§£æ..." in content:
    continue
```

---

## 7. æ•°æ®æµè½¬è®¾è®¡

### 7.1 ä¼šè¯æ¶ˆæ¯æµè½¬

**å†™å…¥æµç¨‹**ï¼š
```
ç”¨æˆ·å‘é€æ¶ˆæ¯
   â†“
APIå±‚æ¥æ”¶
   â†“
Applicationå±‚ï¼šLegacyStreamingService
   â†“
æ­¥éª¤1ï¼šç”ŸæˆåŠ©æ‰‹å›ç­”ï¼ˆæµå¼è¿”å›ç»™ç”¨æˆ·ï¼‰
   â†“
æ­¥éª¤2ï¼šå­˜å‚¨ç”¨æˆ·æ¶ˆæ¯
   - message_repo.append_message(role="user", content=query)
   - Rediså†™å…¥ï¼šrpushåˆ°messages:{user_id}:{session_id}
   - ESå†™å…¥ï¼šindexåˆ°messagesç´¢å¼•
   â†“
æ­¥éª¤3ï¼šå­˜å‚¨åŠ©æ‰‹å›ç­”
   - message_repo.append_message(role="assistant", content=answer)
   - Rediså†™å…¥
   - ESå†™å…¥
   â†“
å®Œæˆ
```

**è¯»å–æµç¨‹**ï¼š
```
åŠ è½½å†å²æ¶ˆæ¯
   â†“
message_repo.get_messages(user_id, session_id)
   â†“
æ­¥éª¤1ï¼šå°è¯•ä»Redisè¯»å–
   - Redis key: messages:{user_id}:{session_id}
   - lrange 0 -1
   â†“
æ­¥éª¤2ï¼šRediså‘½ä¸­ï¼Ÿ
   Yes â”€â†’ è¿”å›æ¶ˆæ¯åˆ—è¡¨
   No â”€â†’ ç»§ç»­
   â†“
æ­¥éª¤3ï¼šä»ESæŸ¥è¯¢
   - index: messages
   - query: {"bool": {"must": [{"term": {"user_id": ...}}, {"term": {"session_id": ...}}]}}
   - sort: timestamp asc
   â†“
æ­¥éª¤4ï¼šå›å¡«Redis
   - rpushæ¯æ¡æ¶ˆæ¯åˆ°Redis
   - expireè®¾ç½®ä¸º86400ç§’ï¼ˆ24å°æ—¶ï¼‰
   â†“
æ­¥éª¤5ï¼šè¿”å›æ¶ˆæ¯åˆ—è¡¨
```

### 7.2 ä¼šè¯å…ƒæ•°æ®æµè½¬

**åˆ›å»ºä¼šè¯æµç¨‹**ï¼š
```
ç”¨æˆ·åˆ›å»ºä¼šè¯
   â†“
APIå±‚ï¼šPOST /api/v1/sessions
   â†“
Applicationå±‚ï¼šSessionService.create_session()
   â†“
æ­¥éª¤1ï¼šç”Ÿæˆsession_idï¼ˆUUIDï¼‰
   â†“
æ­¥éª¤2ï¼šå†™å…¥MySQLï¼ˆä¸»å­˜å‚¨ï¼‰
   - INSERT INTO sessions ...
   - äº‹åŠ¡ä¿è¯
   â†“
æ­¥éª¤3ï¼šå†™å…¥Redisï¼ˆç¼“å­˜ï¼‰
   - key: sessions:{user_id}
   - hset session_id, session_meta_json
   â†“
æ­¥éª¤4ï¼šå†™å…¥ESï¼ˆæ£€ç´¢ï¼Œå®¹é”™ï¼‰
   - index: sessions
   - doc_id: session_id
   - å¤±è´¥ä¸å½±å“å‰ä¸¤æ­¥
   â†“
æ­¥éª¤5ï¼šè¿”å›ä¼šè¯å…ƒæ•°æ®
```

**æŸ¥è¯¢ä¼šè¯åˆ—è¡¨æµç¨‹**ï¼š
```
ç”¨æˆ·æŸ¥è¯¢ä¼šè¯
   â†“
APIå±‚ï¼šGET /api/v1/sessions/{user_id}
   â†“
Applicationå±‚ï¼šSessionService.get_user_sessions()
   â†“
æ­¥éª¤1ï¼šå°è¯•ä»Redisè¯»å–
   - key: sessions:{user_id}
   - hgetall
   â†“
æ­¥éª¤2ï¼šRediså‘½ä¸­ï¼Ÿ
   Yes â”€â†’ è¿”å›ä¼šè¯åˆ—è¡¨ï¼ˆæŒ‰created_atå€’åºï¼‰
   No â”€â†’ ç»§ç»­
   â†“
æ­¥éª¤3ï¼šä»MySQLæŸ¥è¯¢
   - SELECT * FROM sessions WHERE user_id = ? ORDER BY created_at DESC
   â†“
æ­¥éª¤4ï¼šå›å¡«Redis
   - hsetæ¯ä¸ªsession_idå’Œå…ƒæ•°æ®
   â†“
æ­¥éª¤5ï¼šè¿”å›ä¼šè¯åˆ—è¡¨
```

**åˆ é™¤ä¼šè¯æµç¨‹**ï¼š
```
ç”¨æˆ·åˆ é™¤ä¼šè¯
   â†“
APIå±‚ï¼šDELETE /api/v1/sessions/{session_id}
   â†“
Applicationå±‚ï¼šSessionService.delete_session()
   â†“
æ­¥éª¤1ï¼šåˆ é™¤MySQL
   - DELETE FROM sessions WHERE session_id = ?
   â†“
æ­¥éª¤2ï¼šåˆ é™¤Redis
   - hdel sessions:{user_id}, session_id
   â†“
æ­¥éª¤3ï¼šåˆ é™¤ESï¼ˆå®¹é”™ï¼‰
   - delete_document("sessions", session_id)
   â†“
æ­¥éª¤4ï¼šåˆ é™¤ä¼šè¯æ¶ˆæ¯
   - message_repo.delete_messages(user_id, session_id)
   - åˆ é™¤Redis: messages:{user_id}:{session_id}
   - åˆ é™¤ES: queryåˆ é™¤æ‰€æœ‰è¯¥ä¼šè¯çš„æ¶ˆæ¯
   â†“
æ­¥éª¤5ï¼šè¿”å›åˆ é™¤ç»“æœ
```

### 7.3 çŸ¥è¯†æ£€ç´¢æµè½¬

**ESæ£€ç´¢æµç¨‹**ï¼š
```
ç”¨æˆ·æŸ¥è¯¢
   â†“
Applicationå±‚ï¼šLegacyStreamingService._es_stream_gen()
   â†“
æ­¥éª¤1ï¼šæ ‡å‡†åŒ–è¯†åˆ«
   - è¾“å‡ºï¼šstandard_code, standard_name
   â†“
æ­¥éª¤2ï¼šå‘é‡åŒ–
   - è°ƒç”¨embedding_client.embed(query)
   - è¿”å›ï¼šquery_vectorï¼ˆ768ç»´ï¼‰
   â†“
æ­¥éª¤3ï¼šæ„å»ºhybridæŸ¥è¯¢
   - BM25éƒ¨åˆ†ï¼šmatchæŸ¥è¯¢ï¼ŒåŸºäºstandard_name
   - å‘é‡éƒ¨åˆ†ï¼šscript_scoreæŸ¥è¯¢ï¼ŒåŸºäºquery_vector
   â†“
æ­¥éª¤4ï¼šæ‰§è¡ŒESæŸ¥è¯¢
   - es_client.hybrid_search()
   - è¿”å›ï¼šTop-10æ–‡æ¡£ï¼Œæ¯ä¸ªæ–‡æ¡£åŒ…å«_score
   â†“
æ­¥éª¤5ï¼šè½¬æ¢ä¸ºKnowledgeå¯¹è±¡
   - è°ƒç”¨Knowledge.from_es_hit()
   - å½’ä¸€åŒ–scoreï¼šsigmoid(raw_score / 10)
   â†“
æ­¥éª¤6ï¼šè¿”å›Knowledgeåˆ—è¡¨
```

**çŸ¥è¯†åŒ¹é…æµè½¬**ï¼š
```
æ£€ç´¢åˆ°çš„Knowledgeåˆ—è¡¨ï¼ˆ10æ¡ï¼‰
   â†“
knowledge_matcher.match_knowledge(llm_output, knowledge_list, top_k=3)
   â†“
æ­¥éª¤1ï¼šå¯¹llm_outputåˆ†è¯
   - ä½¿ç”¨jiebaåˆ†è¯
   â†“
æ­¥éª¤2ï¼šå¯¹æ¯æ¡knowledge.contentåˆ†è¯
   â†“
æ­¥éª¤3ï¼šè®¡ç®—TF-IDF
   - TFï¼šè¯é¢‘ç»Ÿè®¡
   - IDFï¼šlog(æ€»æ–‡æ¡£æ•° / åŒ…å«è¯¥è¯çš„æ–‡æ¡£æ•°)
   â†“
æ­¥éª¤4ï¼šè®¡ç®—BM25åˆ†æ•°
   - ä½¿ç”¨BM25å…¬å¼ï¼ˆk1=1.5, b=0.75ï¼‰
   â†“
æ­¥éª¤5ï¼šæ’åº
   - æŒ‰BM25åˆ†æ•°é™åºæ’åº
   â†“
æ­¥éª¤6ï¼šè¿”å›Top-3çŸ¥è¯†
```

---

## æ–‡æ¡£å˜æ›´è®°å½•

| ç‰ˆæœ¬ | æ—¥æœŸ | ä½œè€… | å˜æ›´è¯´æ˜ |
|-----|------|------|---------|
| 3.0 | 2025-12-26 | Claude | åŸºäºå®é™…ä»£ç é‡å†™ï¼Œèšç„¦æ ¸å¿ƒæµç¨‹å’Œå…³é”®è®¾è®¡ |
| 2.0 | 2025-12-18 | hyy | åˆå§‹ç‰ˆæœ¬ |

---

**ç›¸å…³æ–‡æ¡£**ï¼š
- [éœ€æ±‚æ–‡æ¡£](00-éœ€æ±‚æ–‡æ¡£.md) - ç³»ç»ŸåŠŸèƒ½å’Œä¸šåŠ¡éœ€æ±‚
- [æ¶æ„è®¾è®¡æ–‡æ¡£](01-æ¶æ„è®¾è®¡æ–‡æ¡£.md) - åˆ†å±‚æ¶æ„å’Œè®¾è®¡åŸåˆ™
- [æ•°æ®åº“è®¾è®¡æ–‡æ¡£](03-æ•°æ®åº“è®¾è®¡æ–‡æ¡£.md) - å­˜å‚¨æ–¹æ¡ˆå’Œæ•°æ®ç»“æ„
- [README](README.md) - é¡¹ç›®å¿«é€Ÿå…¥é—¨
