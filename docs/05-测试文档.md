# 测试文档

## 测试概述

本项目实现了全面的单元测试覆盖，包括Domain层、Infrastructure层、Application层和Core层的所有关键功能。

## 测试结构

```
项目根目录/
├── pytest.ini                   # pytest配置文件（项目根目录）
└── tests/                       # 测试目录
    ├── __init__.py              # 测试包初始化
    ├── conftest.py              # pytest全局配置和fixtures
    ├── test_domain_services.py   # Domain层服务测试（~30个测试）
    ├── test_infrastructure.py    # Infrastructure层客户端和仓储测试（~35个测试）
    ├── test_application.py       # Application层服务测试（~25个测试）
    └── test_core.py              # Core层工具测试（~28个测试）

总计: ~118个测试用例

说明:
- pytest.ini位于项目根目录，而非tests目录
- tests/__init__.py包含测试包说明和快速使用指南
- 所有测试文件直接位于tests目录下，不再使用unit/integration子目录
- conftest.py提供全局mock fixtures供所有测试使用
```

## 测试覆盖范围

### Domain层测试 (test_domain_services.py)

#### Neo4jQueryService
- ✅ 流式查询成功测试
- ✅ 空历史记录查询测试
- ✅ JsonExtractor提取有效JSON
- ✅ JsonExtractor无JSON返回None
- ✅ Neo4jIntentParser初始化
- ✅ 构建意图识别提示词
- ✅ 错误处理测试

#### ESQueryService
- ✅ ES流式查询成功测试
- ✅ 从LLM解析ES意图
- ✅ 检索配置初始化
- ✅ 不同检索类型的ES搜索（keyword/semantic/hybrid）
- ✅ 知识匹配逻辑

#### PromptBuilder
- ✅ 构建系统提示词
- ✅ 构建包含上下文的用户提示词
- ✅ 构建不包含上下文的用户提示词

#### KnowledgeMatcher
- ✅ 匹配知识项
- ✅ 格式化知识用于显示

#### MemoryService
- ✅ 存储和检索记忆
- ✅ 清除记忆
- ✅ 获取最近的消息

#### LLMIntentRouter
- ✅ 路由到Neo4j场景
- ✅ 路由到ES场景
- ✅ 路由到Hybrid场景
- ✅ 带历史记录的路由

#### 集成测试
- ✅ Neo4j到ES的混合流程测试

### Infrastructure层测试 (test_infrastructure.py)

#### LLMClient
- ✅ 同步非流式对话
- ✅ 同步流式对话
- ✅ 异步非流式对话
- ✅ 异步流式对话
- ✅ 消息格式构建
- ✅ **已集成重试机制**

#### ESClient
- ✅ 基本搜索
- ✅ 带size参数的搜索
- ✅ 索引文档
- ✅ 删除文档
- ✅ 更新文档
- ✅ 批量操作
- ✅ BM25 + 向量混合搜索
- ✅ **已集成重试机制**

#### Neo4jClient
- ✅ 基本Cypher查询
- ✅ 带参数的Cypher查询
- ✅ 关系查询
- ✅ 连接测试
- ✅ 关闭连接
- ✅ **已集成重试机制**

#### SessionRepository
- ✅ 获取会话
- ✅ 创建会话
- ✅ 更新会话
- ✅ 获取不存在的会话

#### MessageRepository
- ✅ 获取历史消息
- ✅ 保存消息
- ✅ 获取限制数量的历史消息
- ✅ 保存多条消息

#### Redis缓存
- ✅ 缓存设置和获取
- ✅ 缓存过期
- ✅ 缓存删除
- ✅ 缓存存在性检查

#### MySQL数据库
- ✅ 执行查询
- ✅ 获取单条记录
- ✅ 获取所有记录

#### 集成测试
- ✅ LLM到ES的完整流程
- ✅ 会话和消息的完整流程
- ✅ Neo4j查询结果到LLM总结的流程

### Application层测试 (test_application.py)

#### LegacyStreamingService
- ✅ Neo4j场景的流式查询
- ✅ ES场景的流式查询
- ✅ 混合场景的流式查询
- ✅ 保存对话历史
- ✅ 获取对话上下文
- ✅ 流式查询中的错误处理

#### SSE消息格式
- ✅ 思考消息格式（message_type=1）
- ✅ 数据消息格式（message_type=2）
- ✅ 知识消息格式（message_type=3）
- ✅ 错误消息格式（message_type=4）

#### 路由逻辑
- ✅ 路由决策：Neo4j
- ✅ 路由决策：ES
- ✅ 路由决策：Hybrid

#### 混合流程
- ✅ 先Neo4j后ES的混合流程
- ✅ 混合结果合并

#### 性能测试
- ✅ 并发查询处理
- ✅ 大量历史消息的内存使用
- ✅ 流式输出块大小

#### 端到端集成测试
- ✅ 完整Neo4j查询流程
- ✅ 完整ES查询流程
- ✅ 完整混合查询流程

### Core层测试 (test_core.py)

#### 重试机制 (core.retry)
- ✅ 同步重试：第一次尝试成功
- ✅ 同步重试：失败后重试成功
- ✅ 同步重试：超过最大尝试次数
- ✅ 同步重试：只重试特定异常
- ✅ 同步重试：非目标异常不重试
- ✅ 异步重试：第一次尝试成功
- ✅ 异步重试：失败后重试成功
- ✅ 异步重试：超过最大尝试次数
- ✅ 异步重试：指数退避
- ✅ 重试回调函数
- ✅ **已集成到LLMClient、ESClient、Neo4jClient**

#### 缓存策略 (core.cache)
- ✅ 缓存设置和获取
- ✅ 缓存TTL过期
- ✅ LRU淘汰策略
- ✅ 缓存清除
- ✅ 缓存删除特定键
- ✅ 缓存装饰器
- ✅ 缓存统计信息

#### 配置管理 (core.config)
- ✅ 从环境变量加载配置
- ✅ LLM配置
- ✅ ES配置
- ✅ Neo4j配置
- ✅ MySQL配置
- ✅ Redis配置

#### 日志功能 (core.logging)
- ✅ 日志初始化
- ✅ 日志级别
- ✅ 日志输出

#### 集成测试
- ✅ 重试机制与缓存的集成
- ✅ 配置与日志的集成

## 安装依赖

```bash
pip install -r requirements.txt
```

测试相关依赖已包含在requirements.txt中：
- pytest>=8.3.0
- pytest-asyncio>=0.23.0
- pytest-cov>=5.0.0

## 运行测试

### 运行所有测试

```bash
pytest
```

### 运行特定层的测试

```bash
# Domain层测试
pytest tests/test_domain_services.py -v

# Infrastructure层测试
pytest tests/test_infrastructure.py -v

# Application层测试
pytest tests/test_application.py -v

# Core层测试
pytest tests/test_core.py -v
```

### 运行特定测试类

```bash
pytest tests/test_domain_services.py::TestNeo4jQueryService -v
pytest tests/test_infrastructure.py::TestLLMClient -v
pytest tests/test_application.py::TestLegacyStreamingService -v
pytest tests/test_core.py::TestRetryMechanism -v
```

### 运行特定测试函数

```bash
pytest tests/test_domain_services.py::TestNeo4jQueryService::test_query_stream_success -v
pytest tests/test_core.py::TestRetryMechanism::test_retry_sync_success_first_attempt -v
```

### 查看详细输出

```bash
pytest -v --tb=short
```

### 生成覆盖率报告

```bash
pytest --cov=domain --cov=infrastructure --cov=application --cov=core --cov-report=html --cov-report=term-missing
```

然后打开 `htmlcov/index.html` 查看详细报告。

### 只运行快速测试

```bash
pytest -m "not slow"
```

### 运行特定标记的测试

```bash
# 只运行单元测试
pytest -m unit

# 只运行集成测试
pytest -m integration

# 只运行异步测试
pytest -m asyncio
```

## Mock Fixtures说明

### conftest.py提供的Fixtures

#### 客户端Mocks
- `mock_llm_client`: Mock的LLM客户端
- `mock_es_client`: Mock的ES客户端
- `mock_neo4j_client`: Mock的Neo4j客户端
- `mock_redis_client`: Mock的Redis客户端
- `mock_mysql_client`: Mock的MySQL客户端

#### 服务Mocks
- `mock_neo4j_query_service`: Mock的Neo4j查询服务
- `mock_es_query_service`: Mock的ES查询服务
- `mock_llm_intent_router`: Mock的LLM意图路由器

#### 仓储Mocks
- `mock_session_repository`: Mock的会话仓储
- `mock_message_repository`: Mock的消息仓储

#### 测试数据
- `sample_question`: 测试问题样本
- `sample_history`: 测试历史消息样本
- `sample_session_data`: 测试会话数据样本
- `sample_neo4j_intent`: 测试Neo4j意图样本
- `sample_es_intent`: 测试ES意图样本
- `sample_cypher_examples`: 测试Cypher示例样本

#### 自动清理
- `reset_singletons`: 每个测试后重置单例
- `mock_environment`: Mock环境变量

## 重试机制集成

已在以下客户端类中集成重试装饰器：

### LLMClient (infrastructure/clients/llm_client.py)
- `@retry_sync(max_attempts=3, delay=1.0, backoff=2.0)` on `sync_nonstream_chat`
- `@retry_async(max_attempts=3, delay=1.0, backoff=2.0)` on `async_nonstream_chat`

### ESClient (infrastructure/clients/es_client.py)
- `@retry_sync(max_attempts=3, delay=0.5, backoff=2.0)` on `search`

### Neo4jClient (infrastructure/clients/neo4j_client.py)
- `@retry_sync(max_attempts=3, delay=0.5, backoff=2.0)` on `execute_query`

重试特性：
- 自动重试失败的请求
- 指数退避策略（backoff=2.0）
- 详细的重试日志
- 可配置的最大尝试次数和延迟时间

## 缓存策略

缓存管理器 (core/cache.py) 提供：

### 特性
- **LRU淘汰策略**: 自动淘汰最少使用的缓存项
- **TTL过期**: 支持缓存项自动过期
- **装饰器支持**: `@cached`装饰器简化缓存使用
- **统计信息**: 缓存命中率、缓存大小等

### 使用示例

```python
from core.cache import cached, CacheManager

# 使用装饰器
@cached(ttl=3600, key_prefix="user")
async def get_user_data(user_id: str):
    # 昂贵的操作
    return await fetch_user_from_db(user_id)

# 直接使用缓存管理器
cache = CacheManager(max_size=1000, default_ttl=3600)
await cache.set("key", "value", ttl=1800)
value = await cache.get("key")
```

## 测试最佳实践

### 1. AAA模式
```python
@pytest.mark.asyncio
async def test_example(mock_client):
    # Arrange (准备)
    input_data = {"test": "data"}

    # Act (执行)
    result = await mock_client.process(input_data)

    # Assert (断言)
    assert result is not None
    assert result["status"] == "success"
```

### 2. 测试隔离
- 每个测试使用独立的mock实例
- 使用fixtures确保测试间独立性
- 自动清理测试数据

### 3. 异步测试
```python
@pytest.mark.asyncio
async def test_async_function():
    result = await some_async_function()
    assert result is not None
```

### 4. 异常测试
```python
def test_exception_handling():
    with pytest.raises(CustomError) as exc_info:
        function_that_raises_error()

    assert "Expected error message" in str(exc_info.value)
```

### 5. Mock使用
```python
def test_with_mock(mock_llm_client):
    # 配置mock返回值
    mock_llm_client.sync_nonstream_chat.return_value = "test response"

    # 执行测试
    result = mock_llm_client.sync_nonstream_chat("test prompt")

    # 验证调用
    assert result == "test response"
    mock_llm_client.sync_nonstream_chat.assert_called_once()
```

## CI/CD集成

在GitHub Actions中运行测试：

```yaml
name: Tests

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Run tests
        run: |
          pytest --cov=domain --cov=infrastructure --cov=application --cov=core --cov-report=xml

      - name: Upload coverage
        uses: codecov/codecov-action@v2
```

## 注意事项

1. **Mock优先**: 测试使用Mock fixtures，不需要真实的外部服务
2. **环境隔离**: 测试自动mock环境变量
3. **并发安全**: 测试可以并发运行（使用`-n auto`）
4. **清晰断言**: 所有断言都有明确的期望值
5. **完整覆盖**: 测试覆盖了正常流程和异常流程

## 下一步计划

- [ ] 集成到CI/CD流水线
- [ ] 添加性能基准测试
- [ ] 添加压力测试
- [ ] 提升测试覆盖率到90%以上
- [ ] 添加端到端功能测试
- [ ] 添加API接口测试