# COMBINE_LLM 快速开始指南

## 目录

1. [系统要求](#系统要求)
2. [安装步骤](#安装步骤)
3. [配置说明](#配置说明)
4. [启动应用](#启动应用)
5. [API使用示例](#api使用示例)
6. [常见问题](#常见问题)

---

## 系统要求

### 必需服务

- **Python**: 3.9+
- **Redis**: 5.0+
- **MySQL**: 8.0+
- **Elasticsearch**: 8.0+
- **Neo4j**: 5.0+ (可选，用于知识图谱)

### 硬件要求

- **CPU**: 4核+
- **内存**: 8GB+
- **磁盘**: 20GB+

---

## 安装步骤

### 1. 克隆项目

```bash
git clone <repository_url>
cd combine_llm_new
```

### 2. 创建虚拟环境

```bash
# Windows
python -m venv venv
venv\Scripts\activate

# Linux/Mac
python3 -m venv venv
source venv/bin/activate
```

### 3. 安装依赖

```bash
pip install -r requirements.txt
```

### 4. 启动必要服务

#### Redis
```bash
# Windows (使用WSL或Docker)
docker run -d -p 6379:6379 redis:7

# Linux
redis-server

# Mac
brew services start redis
```

#### MySQL
```bash
# 使用Docker
docker run -d -p 3306:3306 \
  -e MYSQL_ROOT_PASSWORD=root \
  -e MYSQL_DATABASE=chatdb \
  mysql:8

# 或使用本地MySQL服务
```

#### Elasticsearch
```bash
# 使用Docker
docker run -d -p 9200:9200 -p 9300:9300 \
  -e "discovery.type=single-node" \
  -e "xpack.security.enabled=false" \
  elasticsearch:8.0.0
```

#### Neo4j (可选)
```bash
# 使用Docker
docker run -d -p 7474:7474 -p 7687:7687 \
  -e NEO4J_AUTH=neo4j/password \
  neo4j:5.0
```

---

## 配置说明

### 1. 创建环境配置文件

```bash
cp .env.example .env
```

### 2. 编辑 .env 文件

```env
# ============= 基础配置 =============
ENV=development
LOG_LEVEL=INFO

# ============= Redis配置 =============
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_DB=0
REDIS_PASSWORD=

# ============= MySQL配置 =============
MYSQL_HOST=localhost
MYSQL_PORT=3306
MYSQL_USER=root
MYSQL_PASSWORD=root
MYSQL_DATABASE=chatdb

# ============= Elasticsearch配置 =============
ES_HOST=localhost
ES_PORT=9200
ES_USERNAME=
ES_PASSWORD=

# ============= Neo4j配置（可选）=============
NEO4J_URI=bolt://localhost:7687
NEO4J_USER=neo4j
NEO4J_PASSWORD=password

# ============= LLM配置 =============
LLM_MODEL=gpt-3.5-turbo
LLM_API_KEY=your_openai_api_key_here
LLM_BASE_URL=https://api.openai.com/v1
LLM_MAX_TOKENS=2000
LLM_TEMPERATURE=0.7
```

### 3. 初始化数据库

```sql
-- 连接到MySQL
mysql -u root -p

-- 创建数据库（如果不存在）
CREATE DATABASE IF NOT EXISTS chatdb CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- 使用数据库
USE chatdb;

-- 创建用户表
CREATE TABLE IF NOT EXISTS users (
    user_id VARCHAR(255) PRIMARY KEY,
    username VARCHAR(100),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 创建会话表
CREATE TABLE IF NOT EXISTS sessions (
    session_id VARCHAR(255) PRIMARY KEY,
    user_id VARCHAR(255),
    name VARCHAR(200),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    is_active BOOLEAN DEFAULT TRUE,
    INDEX idx_user_id (user_id),
    INDEX idx_updated_at (updated_at)
);
```

---

## 启动应用

### 开发模式

```bash
# 方式1: 直接运行main.py
python main.py

# 方式2: 使用uvicorn
uvicorn main:app --reload --host 0.0.0.0 --port 8000
```

### 生产模式

```bash
uvicorn main:app --host 0.0.0.0 --port 8000 --workers 4
```

### 验证启动

访问以下URL验证服务:

- **根路径**: http://localhost:8000/
- **API文档**: http://localhost:8000/docs
- **健康检查**: http://localhost:8000/api/health/

---

## API使用示例

### 1. 健康检查

```bash
# 基础健康检查
curl http://localhost:8000/api/health/

# 详细健康检查
curl http://localhost:8000/api/health/detailed
```

**响应示例**:
```json
{
  "status": "healthy",
  "services": {
    "redis": "healthy",
    "mysql": "healthy",
    "elasticsearch": "healthy"
  }
}
```

### 2. 创建会话

```bash
curl -X POST "http://localhost:8000/api/sessions/" \
  -H "Content-Type: application/json" \
  -d '{
    "user_id": "user_001",
    "name": "我的第一次对话"
  }'
```

**响应示例**:
```json
{
  "session_id": "550e8400-e29b-41d4-a716-446655440000",
  "user_id": "user_001",
  "name": "我的第一次对话",
  "created_at": "2024-01-01T10:00:00",
  "message_count": 0
}
```

### 3. 发起对话

```bash
curl -X POST "http://localhost:8000/api/chat/" \
  -H "Content-Type: application/json" \
  -d '{
    "session_id": "550e8400-e29b-41d4-a716-446655440000",
    "user_id": "user_001",
    "query": "你好，请介绍一下你自己",
    "enable_knowledge": false
  }'
```

**响应示例**:
```json
{
  "session_id": "550e8400-e29b-41d4-a716-446655440000",
  "query": "你好，请介绍一下你自己",
  "response": "你好！我是一个专业的AI助手...",
  "intent": null,
  "knowledge_count": 0,
  "knowledge": [],
  "metadata": {
    "llm_model": "gpt-3.5-turbo",
    "usage": {
      "total_tokens": 150
    }
  }
}
```

### 4. 带知识检索的对话

```bash
curl -X POST "http://localhost:8000/api/chat/" \
  -H "Content-Type: application/json" \
  -d '{
    "session_id": "550e8400-e29b-41d4-a716-446655440000",
    "user_id": "user_001",
    "query": "什么是等保三级？",
    "enable_knowledge": true,
    "top_k": 5
  }'
```

**响应示例**:
```json
{
  "session_id": "550e8400-e29b-41d4-a716-446655440000",
  "query": "什么是等保三级？",
  "response": "等保三级是指国家信息安全等级保护的第三级...",
  "intent": {
    "intent_type": "es_query",
    "confidence": 0.85,
    "metadata": {
      "parser": "ESIntentParser",
      "keywords": ["什么", "等保三级"]
    }
  },
  "knowledge_count": 3,
  "knowledge": [
    {
      "content": "等保三级要求...",
      "source": "elasticsearch",
      "score": 0.92,
      "title": "等保三级介绍"
    }
  ],
  "metadata": {
    "llm_model": "gpt-3.5-turbo",
    "usage": {
      "total_tokens": 250
    },
    "history_length": 2
  }
}
```

### 5. 流式对话

```bash
curl -X POST "http://localhost:8000/api/chat/stream" \
  -H "Content-Type: application/json" \
  -d '{
    "session_id": "550e8400-e29b-41d4-a716-446655440000",
    "user_id": "user_001",
    "query": "等保三级和等保二级有什么区别？",
    "enable_knowledge": true
  }'
```

**SSE响应示例**:
```
event: start
data: {"session_id": "550e8400-e29b-41d4-a716-446655440000"}

event: retrieval_start
data: {}

event: retrieval_done
data: {"intent": {"intent_type": "es_query", "confidence": 0.88}, "knowledge_count": 4}

event: content
data: {"text": "等保"}

event: content
data: {"text": "三级"}

event: content
data: {"text": "和"}

event: content
data: {"text": "等保"}

event: content
data: {"text": "二级"}

... (更多内容块)

event: done
data: {"session_id": "550e8400-e29b-41d4-a716-446655440000", "total_length": 256}
```

### 6. 获取会话列表

```bash
curl "http://localhost:8000/api/sessions/?user_id=user_001&limit=10&offset=0"
```

**响应示例**:
```json
{
  "sessions": [
    {
      "session_id": "550e8400-e29b-41d4-a716-446655440000",
      "name": "我的第一次对话",
      "created_at": "2024-01-01T10:00:00",
      "updated_at": "2024-01-01T10:15:00",
      "message_count": 6
    }
  ],
  "total": 1,
  "limit": 10,
  "offset": 0
}
```

### 7. 获取会话详情（包含消息）

```bash
curl "http://localhost:8000/api/sessions/550e8400-e29b-41d4-a716-446655440000?user_id=user_001&include_messages=true"
```

### 8. 删除会话

```bash
curl -X DELETE "http://localhost:8000/api/sessions/550e8400-e29b-41d4-a716-446655440000?user_id=user_001"
```

---

## Python客户端示例

### 同步方式

```python
import requests

# 1. 创建会话
response = requests.post(
    "http://localhost:8000/api/sessions/",
    json={
        "user_id": "user_001",
        "name": "测试会话"
    }
)
session = response.json()
session_id = session["session_id"]

# 2. 发起对话
response = requests.post(
    "http://localhost:8000/api/chat/",
    json={
        "session_id": session_id,
        "user_id": "user_001",
        "query": "什么是等保三级？",
        "enable_knowledge": True,
        "top_k": 5
    }
)
result = response.json()
print(f"助手回复: {result['response']}")
print(f"使用知识数: {result['knowledge_count']}")
```

### 异步方式

```python
import asyncio
import httpx

async def chat_example():
    async with httpx.AsyncClient() as client:
        # 创建会话
        response = await client.post(
            "http://localhost:8000/api/sessions/",
            json={
                "user_id": "user_001",
                "name": "异步测试会话"
            }
        )
        session = response.json()
        session_id = session["session_id"]

        # 对话
        response = await client.post(
            "http://localhost:8000/api/chat/",
            json={
                "session_id": session_id,
                "user_id": "user_001",
                "query": "你好",
                "enable_knowledge": False
            }
        )
        result = response.json()
        print(f"助手回复: {result['response']}")

asyncio.run(chat_example())
```

### 流式对话

```python
import requests

def chat_stream_example():
    response = requests.post(
        "http://localhost:8000/api/chat/stream",
        json={
            "session_id": "your-session-id",
            "user_id": "user_001",
            "query": "介绍一下等保三级",
            "enable_knowledge": True
        },
        stream=True
    )

    for line in response.iter_lines():
        if line:
            line = line.decode('utf-8')
            if line.startswith('data: '):
                data = line[6:]  # 移除 'data: ' 前缀
                print(data)

chat_stream_example()
```

---

## 常见问题

### Q1: 启动时提示Redis连接失败

**解决方案**:
1. 确认Redis服务已启动: `redis-cli ping`
2. 检查.env中的Redis配置
3. 检查防火墙设置

### Q2: MySQL连接错误

**解决方案**:
1. 确认MySQL服务运行: `mysql -u root -p`
2. 确认数据库已创建: `CREATE DATABASE chatdb;`
3. 检查用户名密码配置

### Q3: Elasticsearch连接失败

**解决方案**:
1. 确认ES服务运行: `curl http://localhost:9200`
2. 如果使用Docker，检查容器状态
3. 确认ES版本兼容

### Q4: LLM调用失败

**解决方案**:
1. 检查API Key是否正确
2. 检查网络连接
3. 确认模型名称正确
4. 查看日志文件: `logs/app.log`

### Q5: 限流提示Too Many Requests

**解决方案**:
- 降低请求频率
- 或修改main.py中的限流配置

### Q6: 如何查看详细日志

**日志位置**: `logs/app.log`

**调整日志级别**:
在.env中设置:
```
LOG_LEVEL=DEBUG
```

---

## 进阶配置

### Docker Compose部署

创建 `docker-compose.yml`:

```yaml
version: '3.8'

services:
  redis:
    image: redis:7
    ports:
      - "6379:6379"

  mysql:
    image: mysql:8
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: chatdb
    ports:
      - "3306:3306"

  elasticsearch:
    image: elasticsearch:8.0.0
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
    ports:
      - "9200:9200"
      - "9300:9300"

  app:
    build: .
    ports:
      - "8000:8000"
    depends_on:
      - redis
      - mysql
      - elasticsearch
    environment:
      - REDIS_HOST=redis
      - MYSQL_HOST=mysql
      - ES_HOST=elasticsearch
```

启动:
```bash
docker-compose up -d
```

---

## 下一步

1. 查看 [API文档](http://localhost:8000/docs)
2. 阅读 [架构文档](./实现路线.md)
3. 查看 [测试文档](../tests/README.md)
4. 贡献代码（参考CONTRIBUTING.md）

---

## 技术支持

如遇问题，请:
1. 查看日志文件 `logs/app.log`
2. 检查配置文件 `.env`
3. 查阅文档 `docs/`
4. 提交Issue

祝使用愉快！
