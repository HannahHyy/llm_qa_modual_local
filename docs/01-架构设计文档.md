# COMBINE_LLM 系统架构设计文档

## 版本：2.0
## 更新日期：2025-12-18
## 文档性质：架构设计

---

## 📌 文档说明

**架构设计文档**描述"系统该如何组织"：
- ✅ 系统分成哪些大模块
- ✅ 各模块负责什么职责
- ✅ 模块之间如何协作
- ✅ 技术选型与理由
- ✅ 数据流转方式

**不包含**：具体类定义、方法实现、算法细节（见《详细设计文档》）

---

## 目录

1. [系统概述](#1-系统概述)
2. [架构原则与目标](#2-架构原则与目标)
3. [系统分层架构](#3-系统分层架构)
4. [核心模块划分](#4-核心模块划分)
5. [技术选型](#5-技术选型)
6. [数据流设计](#6-数据流设计)
7. [部署架构](#7-部署架构)

---

## 1. 系统概述

### 1.1 系统定位

**COMBINE_LLM** 是一个基于大模型的智能问答系统，为用户提供：
- 网络业务情况查询（基于Neo4j知识图谱）
- 法规标准查询（基于Elasticsearch向量检索）
- 多轮对话支持（基于Redis会话管理）

### 1.2 核心特性

| 特性 | 说明 |
|-----|------|
| **多知识库检索** | 支持ES向量库检索、Neo4j图知识库检索、混合检索三种模式 |
| **流式响应** | SSE流式输出，提供实时思考过程展示 |
| **会话管理** | Redis缓存 + ES持久化的双层存储 |
| **长期记忆** | 基于用户历史的个性化问答 |
| **可观测性** | 完整的日志、监控、追踪体系 |

### 1.3 业务流程概览

```
用户提问 → 意图路由（ES/Neo4j/混合） → 知识检索 → LLM生成 → 流式返回 → 会话存储
```

---

## 2. 架构原则与目标

### 2.1 核心目标

- **高内聚-低耦合**：各模块职责单一、边界清晰
- **可维护性**：代码结构清晰、易于理解和修改
- **可扩展性**：支持新功能平滑接入
- **可测试性**：各模块独立可测
- **生产就绪**：完善的配置、日志、监控、错误处理

### 2.2 设计原则

| 原则 | 说明 | 体现 |
|-----|------|------|
| **单一职责原则（SRP）** | 每个模块只负责一个功能领域 | 例如API层只做路由，不含业务逻辑 |
| **依赖倒置原则（DIP）** | 面向接口编程，不依赖具体实现 | 例如所有检索器对象都继承BaseRetriever抽象类 |
| **开闭原则（OCP）** | 对扩展开放，对修改关闭 | 新增Neo4j检索器不影响ES检索器 |
| **配置外部化** | 所有配置通过环境变量管理 | 使用Pydantic Settings + .env |
| **统一错误处理** | 全局异常处理和降级策略 | 中间件统一捕获异常 |

---

## 3. 系统分层架构

### 3.1 整体架构图

采用**分层 + 模块化架构**，分为4层 + 1个横切关注点：
API层：接收HTTP请求、参数校验、返回响应
应用服务层：协调领域服务完成完整业务流程
领域逻辑层：意图解析、知识检索、提示词构建、知识匹配       
基础设施层：提供统一接口访问数据库和外部服务    
横切关注点：日志、监控、配置、异常处理、限流、鉴权    

```
┌─────────────────────────────────────────────────────────────┐
│                 API层 (API Gateway Layer)                   │
│               FastAPI路由 - 请求验证与响应                    │
│         职责：接收HTTP请求、参数校验、返回响应                 │
└────────────────────────┬────────────────────────────────────┘
                         ↓ (依赖注入)
┌─────────────────────────────────────────────────────────────┐
│            应用服务层 (Application Service Layer)            │
│              业务流程编排 - 不含领域逻辑                      │
│    职责：协调领域服务完成完整业务流程（对话、会话管理）          │
│    ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│    │ Chat Service │  │ Session Svc  │  │Streaming Svc │     │
│    └──────────────┘  └──────────────┘  └──────────────┘     │
└────────────────────────┬────────────────────────────────────┘
                         ↓ (调用)
┌─────────────────────────────────────────────────────────────┐
│               领域逻辑层 (Domain Logic Layer)                │
│                 核心业务逻辑 - 独立于框架                     │
│    职责：意图解析、知识检索、提示词构建、知识匹配               │
│    ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│    │ Intent Parser│  │  Retriever   │  │Prompt Builder│     │
│    └──────────────┘  └──────────────┘  └──────────────┘     │
│    ┌──────────────┐  ┌──────────────┐                       │
│    │Knowledge Match│ │ Memory Svc   │                       │
│    └──────────────┘  └──────────────┘                       │
└────────────────────────┬────────────────────────────────────┘
                         ↓ (访问)
┌─────────────────────────────────────────────────────────────┐
│             基础设施层 (Infrastructure Layer)                │
│              封装外部系统 - 数据库、API、服务                 │
│    职责：提供统一接口访问数据库和外部服务                      │
│    ┌──────────────┐  ┌──────────────┐  ┌──────────────┐    │
│    │  LLM Client  │  │  ES Client   │  │ Neo4j Client │    │
│    └──────────────┘  └──────────────┘  └──────────────┘    │
│    ┌──────────────┐  ┌──────────────┐  ┌──────────────┐    │
│    │ Redis Client │  │ MySQL Client │  │Embedding Svc │    │
│    └──────────────┘  └──────────────┘  └──────────────┘    │
│    ┌──────────────────────────────────────────────────┐    │
│    │  Repository层（数据访问抽象）                      │    │
│    │  SessionRepo | MessageRepo | KnowledgeRepo       │    │
│    └──────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│            横切关注点 (Cross-Cutting Concerns)               │
│           日志、监控、配置、异常处理、限流、鉴权                │
└─────────────────────────────────────────────────────────────┘
```

---

## 4. 核心模块划分

### 4.1 模块全景图

```
combine_llm/
├── api/                # API层：HTTP接口
├── application/        # 应用服务层：业务编排
├── domain/             # 领域逻辑层：核心业务
├── infrastructure/     # 基础设施层：外部系统
├── core/               # 核心基础设施：日志、异常、中间件
├── config/             # 配置管理
├── scripts/            # 工具脚本
├── tests/              # 测试
└── docs/               # 文档
```

### 4.2 各层职责详解

#### 4.2.1 API层（api/）

**职责**：接收HTTP请求、参数验证、返回响应
**原则**：薄层，不包含业务逻辑

| 模块 | 职责 | 示例 |
|-----|------|------|
| `api/v1/chat.py` | 对话API | `POST /api/v1/chat/stream` |
| `api/v1/sessions.py` | 会话管理API | `GET/POST/DELETE /api/v1/sessions` |
| `api/v1/health.py` | 健康检查 | `GET /api/v1/health` |
| `api/schemas/` | 请求/响应模型 | Pydantic模型定义 |

**关键点**：
- 使用Pydantic进行请求验证
- 统一的错误响应格式
- 依赖注入服务层
- 不包含任何业务逻辑

#### 4.2.2 应用服务层（application/）

**职责**：编排领域服务，实现完整的业务流程
**原则**：协调者角色，不包含领域逻辑

| 模块 | 职责 | 编排内容 |
|-----|------|----------|
| `chat_service.py` | 对话服务 | 意图路由 → 检索 → 生成 → 存储 |
| `session_service.py` | 会话管理 | 同步Redis、MySQL、ES状态 |
| `streaming_service.py` | 流式响应 | 标签格式化、缓冲、错误恢复 |

**示例流程**（chat_service.py）：
1. 调用session_service加载历史消息
2. 调用intent_routing策略判断路由
3. 调用对应retriever检索知识
4. 调用prompt_builder构建提示词
5. 调用llm_client生成回答
6. 调用streaming_service流式返回
7. 调用message_repository存储消息

#### 4.2.3 领域逻辑层（domain/）

**职责**：核心业务逻辑，独立于框架和外部服务
**原则**：可独立测试、纯业务逻辑

| 模块组 | 职责 | 实现 |
|-------|------|------|
| `intent_parser/` | 意图解析 | 标准识别、实体提取、查询重写 |
| `retrieval/` | 知识检索 | ES检索、Neo4j检索、混合检索 |
| `knowledge_matcher.py` | 知识匹配 | BM25匹配LLM输出与检索结果 |
| `prompt_builder.py` | 提示词构建 | 拼接历史+知识+query |
| `memory_service.py` | 记忆管理 | 长期记忆检索与更新 |
| `strategies/` | 策略模式 | 意图路由策略、检索策略 |
| `models/` | 领域模型 | Intent、Knowledge、Message、Session |

**设计要点**：
- 所有服务有基类（BaseIntentParser、BaseRetriever）
- 面向接口编程，方便扩展
- 不依赖具体框架（FastAPI无关）
- 可独立单元测试

#### 4.2.4 基础设施层（infrastructure/）

**职责**：封装外部系统交互（数据库、API）
**原则**：可替换、接口统一

| 模块组 | 职责 | 包含 |
|-------|------|------|
| `clients/` | 外部服务客户端 | LLM、ES、Neo4j、Redis、MySQL、Embedding |
| `repositories/` | 数据访问层 | SessionRepo、MessageRepo、KnowledgeRepo |

**客户端统一特性**：
- 连接池管理
- 重试机制
- 超时控制
- 健康检查

**Repository模式作用**：
- 解耦数据访问：业务逻辑不依赖具体数据库
- 统一接口：Redis、ES、MySQL通过统一接口访问
- 缓存策略封装：Redis优先、ES备用逻辑封装在Repository内

#### 4.2.5 核心基础设施（core/）

**职责**：横切关注点（日志、异常、中间件）

| 模块 | 职责 |
|-----|------|
| `logging.py` | 统一日志配置（loguru） |
| `exceptions.py` | 自定义异常类层次 |
| `middleware.py` | 请求日志、限流、鉴权中间件 |
| `dependencies.py` | FastAPI依赖注入配置 |

#### 4.2.6 配置管理（config/）

**职责**：统一配置管理，环境变量加载

| 模块 | 职责 |
|-----|------|
| `settings.py` | 配置类定义（Pydantic Settings） |
| `logging_config.py` | 日志配置 |
| `.env.example` | 环境变量模板 |

---

## 5. 技术选型

### 5.1 核心技术栈

| 类别 | 技术选型 | 版本 | 选型理由 |
|-----|---------|------|----------|
| **Web框架** | FastAPI | 0.115+ | 异步、高性能、自动文档、类型提示 |
| **异步运行时** | uvicorn | 0.30+ | ASGI服务器，支持SSE流式响应 |
| **数据验证** | Pydantic | 2.10+ | 强类型、配置管理、请求验证 |
| **日志** | loguru | 0.7+ | 简洁API、异步写入、自动轮转 |
| **HTTP客户端** | httpx | 0.27+ | 异步HTTP客户端 |
| **测试框架** | pytest | 8.3+ | 单元测试、集成测试、夹具支持 |

### 5.2 数据库与存储

| 技术 | 用途 | 理由 |
|-----|------|------|
| **Elasticsearch** | 向量检索、全文检索、会话历史 | 混合检索能力强，支持向量相似度 |
| **Neo4j** | 知识图谱、业务关系查询 | 原生图数据库，Cypher查询强大 |
| **Redis** | 会话缓存、短期记忆 | 高性能内存数据库，毫秒级响应 |
| **MySQL** | 用户元数据、会话元数据 | 持久化关系数据，事务保证 |

### 5.3 监控与观测

| 工具 | 用途 | 理由 |
|-----|------|------|
| **Prometheus + Grafana** | 性能监控 | 行业标准，丰富的指标体系 |
| **Langfuse** | LLM调用追踪 | 专注LLM应用，trace/span支持 |
| **自定义健康检查** | 服务状态检测 | 快速定位服务故障 |

### 5.4 开发工具

| 工具 | 用途 |
|-----|------|
| **black** | 代码格式化 |
| **isort** | import排序 |
| **mypy** | 静态类型检查 |
| **pylint/flake8** | 代码质量检查 |

---

## 6. 数据流设计

### 6.1 完整对话流程

```
┌──────────────┐
│ 用户发起请求  │
│ POST /chat   │
└──────┬───────┘
       │
       ↓ 1️⃣ API层：参数验证
┌──────────────────────────┐
│ api/v1/chat.py           │
│ - 验证user_id/session_id │
│ - 注入ChatService        │
└──────┬───────────────────┘
       │
       ↓ 2️⃣ 应用服务层：业务编排
┌──────────────────────────┐
│ application/             │
│ ChatService.handle()     │
│ ├─ 加载历史消息          │
│ ├─ 意图路由决策          │
│ ├─ 调用检索流程          │
│ ├─ 构建Prompt           │
│ └─ 流式生成回答          │
└──────┬───────────────────┘
       │
       ↓ 3️⃣ 领域服务层：核心逻辑
┌──────────────────────────┐
│ domain/services/         │
│ ├─ IntentParser.parse()  │
│ ├─ Retriever.retrieve()  │
│ ├─ PromptBuilder.build() │
│ └─ Matcher.match()       │
└──────┬───────────────────┘
       │
       ↓ 4️⃣ 基础设施层：外部调用
┌──────────────────────────┐
│ infrastructure/          │
│ ├─ LLMClient.stream()    │
│ ├─ ESClient.search()     │
│ └─ Repository.save()     │
└──────┬───────────────────┘
       │
       ↓ 5️⃣ 流式返回前端
┌──────────────────────────┐
│ SSE流式响应              │
│ <think>...</think>       │
│ <data>...</data>         │
│ <knowledge>...</knowledge>│
└──────────────────────────┘
```

### 6.2 三种查询模式

#### 模式1：ES查询（法规标准）

```
用户查询 → 意图解析（标准识别、实体提取）
        → ES检索（BM25 + 向量混合）
        → 知识匹配
        → LLM生成
```

#### 模式2：Neo4j查询（业务情况）

```
用户查询 → 意图解析（实体、关系提取）
        → Neo4j图查询（Cypher）
        → 结果格式化
        → LLM生成
```

#### 模式3：混合查询

```
用户查询 → 意图路由（判断需要Neo4j+ES）
        ↓
   [Phase 1] Neo4j查询获取业务信息
        ↓
   [Phase 2] 将业务信息拼接到查询
        ↓
   [Phase 3] ES查询获取法规知识
        ↓
   [Phase 4] 合并两类知识，LLM生成
```

### 6.3 数据存储策略

#### 会话消息存储（双层架构）

```
写入流程：
  用户消息 → 同时写入Redis和ES

读取流程：
  1. 优先从Redis读取（毫秒级）
  2. Redis未命中 → 从ES读取（秒级）
  3. 从ES读取后 → 回填Redis缓存
```

#### 会话元数据存储（三库同步）

```
创建会话：
  1. 写入MySQL（持久化，唯一事实来源）
  2. 写入Redis（快速访问）
  3. 写入ES（便于检索和分析）
```

### 6.4 数据流转时序

```
创建会话:
  API → SessionService → SessionRepository
                        → MySQL.insert()
                        → Redis.hset()
                        → ES.index()

流式对话:
  API → ChatService → SessionService.get_messages()
                     → Redis.lrange() (优先)
                     → ES.search() (未命中)
      → IntentRouter.route()
      → Retriever.retrieve()
      → PromptBuilder.build()
      → LLMClient.stream()
      → StreamingService.format()
      → MessageRepository.save()
                        → Redis.rpush()
                        → ES.index()
```

---

## 7. 部署架构

### 7.1 服务拓扑

```
                        ┌─────────────┐
                        │   Nginx     │  (反向代理、负载均衡)
                        └──────┬──────┘
                               │
                  ┌────────────┴────────────┐
                  ↓                         ↓
           ┌──────────────┐          ┌──────────────┐
           │  FastAPI实例1 │          │  FastAPI实例2 │  (多实例部署)
           └──────┬───────┘          └──────┬───────┘
                  │                         │
                  └────────────┬────────────┘
                               ↓
            ┌──────────────────────────────────────┐
            │        基础设施服务集群                │
            │  ┌────────┐  ┌────────┐  ┌────────┐ │
            │  │ Redis  │  │ MySQL  │  │   ES   │ │
            │  └────────┘  └────────┘  └────────┘ │
            │  ┌────────┐  ┌────────┐  ┌────────┐ │
            │  │ Neo4j  │  │Embedding│  │Langfuse│ │
            │  └────────┘  └────────┘  └────────┘ │
            └──────────────────────────────────────┘
```

### 7.2 部署模式

#### 开发环境

```
单机部署：
  - FastAPI (单实例)
  - Redis (Docker)
  - MySQL (Docker)
  - ES (Docker)
  - Neo4j (Docker)
```

#### 生产环境

```
分布式部署：
  - FastAPI (多实例 + Nginx负载均衡)
  - Redis (主从 + Sentinel)
  - MySQL (主从复制)
  - ES (集群模式，3节点)
  - Neo4j (集群模式)
  - 监控 (Prometheus + Grafana + Langfuse)
```

### 7.3 扩展性设计

| 组件 | 扩展方式 | 说明 |
|-----|---------|------|
| **FastAPI** | 水平扩展 | 无状态服务，通过Nginx负载均衡 |
| **Redis** | 主从+哨兵 | 读写分离，高可用 |
| **MySQL** | 主从复制 | 读写分离 |
| **ES** | 集群模式 | 分片+副本，自动负载均衡 |
| **Neo4j** | 因果集群 | 读写分离，高可用 |



## 文档变更记录

| 版本 | 日期 | 作者 | 变更说明 |
|-----|------|------|---------|
| 2.0 | 2025-12-18 | hyy | 初始版本，架构设计 |


**相关文档**：
- 详细设计文档：`02-详细设计文档.md`
- 数据库设计文档：`03-数据库设计文档.md`
- API接口文档：`04-API接口文档.md`
