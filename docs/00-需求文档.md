# 网络安全智能问答系统 - 需求文档

**文档版本**: v4.0 (完全独立架构)
**编写日期**: 2025-12-26
**负责人**: Senior Software Architect
**状态**: 正式版（基于完全重构后的代码）

---
## 0. 需求分析

本项目旨在构建一个专业、精准、可扩展的多轮智能化对话服务，为用户提供与网络业务情况和相关法规标准相关的智能化大模型问答系统服务。系统需超越简单的关键词匹配，实现对复杂问题的理解、关联与推理，最终提供权威、准确且上下文相关的回答。

### 核心功能需求
1.  **准确的用户意图识别**：用户可能会询问和网络真实业务情况、相关法规标准、以及与知识库无关的问题，系统需能准确的识别用户的意图，根据用户意图准确检索对应知识库内容进行回答。
2.  **多轮对话支持**：支持用户与系统进行连续的多轮交互，系统能理解上下文。
3.  **精准法规问答**：针对用户提出的法规相关问题（如“一级安全通用要求中关于物理访问控制的规定是什么？”），能精确检索ES知识库，并引用原文作答。
4.  **精准网络真实业务情况问答**：针对用户提出的网络业务情况问题（如“河北单位建设了哪些网络?”），能精确检索图数据库，并完全根据图数据库内知识作答。
5.  **长期记忆与个性化服务**：系统需记录每位用户的提问历史。
6.  **当用户提出相似问题时**，系统应能识别并参考该用户过往的互动历史（包括回答内容及用户反馈）来优化本次回答，避免重复错误，提升服务质量，注意，不同用户的对话需隔离。
7.  **专业术语与关系理解**：系统需理解“物理访问控制”、“防火墙”等专业术语，并能掌握它们之间的关联关系。
8.  **高并发与低延迟**：作为生产级服务，系统需具备处理高并发请求的能力，并保证响应速度。

### 非功能需求
1.  **准确性 (Accuracy)**：答案必须严格依据官方标准文档。
2.  **可解释性 (Explainability)**：系统应能清晰地展示其回答所依据的法规原文出处（如标准号、条款序号）。
3.  **可监控性 (Observability)**：系统需集成全面的监控与追踪工具，便于性能分析、问题排查和持续优化。
4.  **可扩展性 (Scalability)**：架构设计需支持未来数据量的增长和新功能的平滑接入。

### 输入与输出
*   **输入**：用户ID (`user_id`) / 会话ID (`session_id`) / 用户的自然语言提问
*   **输出**：流式返回的回答文本 + 回答所依据的法规原文片段及出处

## 一、系统概述

### 1.1 系统定位

本系统是一个专注于**网络安全等级保护合规咨询**的智能问答系统，采用Clean Architecture（DDD）架构，完全独立实现所有核心功能，整合多源知识库和大语言模型技术，为用户提供精准、实时的合规分析和业务查询服务。

### 1.2 核心价值

为网络安全从业人员提供三大核心能力：

**1. 法规标准查询（ES Query）**
- 快速检索等保、网安法等法规标准的具体要求
- 支持BM25关键词检索和向量语义检索
- 自动匹配法规标准原文（Top 2引用）
- 实现：[domain/services/es_query_service.py](../domain/services/es_query_service.py)

**2. 业务情况查询（Neo4j Query）**
- 查询具体单位的网络架构、安全产品配置
- 支持图谱关系查询和多跳路径分析
- 返回结构化的业务数据和Cypher查询结果
- 实现：[domain/services/neo4j_query_service.py](../domain/services/neo4j_query_service.py)

**3. 合规对比分析（Hybrid Query）**
- 智能对比业务情况与法规标准要求
- 先执行Neo4j业务查询，再用结果增强问题执行ES查询
- 识别合规差距和风险点，提供改进建议
- 实现：[application/services/legacy_streaming_service.py](../application/services/legacy_streaming_service.py) (468-561行)

### 1.3 架构特点

**✅ 完全独立实现**
- 所有核心服务100%重写，0依赖外部old代码
- Neo4jQueryService: 630行独立实现
- ESQueryService: 620行独立实现
- 通过依赖注入实现松耦合

**✅ Clean Architecture（DDD）**
- 4层架构：API → Application → Domain → Infrastructure → Core
- 依赖方向：所有依赖向内指向Core
- 易于测试、扩展和维护

**✅ 流式输出**
- 所有查询支持SSE（Server-Sent Events）实时流式输出
- 思考过程（`<think>`）和答案内容（`<data>`）分离
- 提升用户体验，降低感知延迟

### 1.4 知识来源

系统整合两大知识库：

#### Elasticsearch法规标准知识库
- **内容**：网络安全法、等保条例、GB/T标准、行业规范等权威文档
- **技术**：混合检索（BM25关键词 + 向量语义）
- **索引**：
  - `kb_vector_store`（法规标准，配置key: `ES_KNOWLEDGE_INDEX`）
  - `conversation_history`（对话历史，配置key: `ES_CONVERSATION_INDEX`）
- **规模**：数万条法规条款和标准要求

#### Neo4j业务图谱知识库
- **内容**：具体单位的网络架构、系统配置、安全产品部署、责任关系
- **技术**：图数据库 + Cypher查询 + LLM辅助生成
- **节点类型**：单位、网络、系统、设备、安全产品、集成商
- **关系类型**：拥有、包含、部署、集成
- **特点**：支持多跳关系查询和复杂路径分析

---

## 二、核心业务场景

系统通过`scene_id`参数区分三种查询场景，每种场景对应不同的处理流程。

### 场景1：混合查询（scene_id=1）

#### 适用情况
用户问题需要结合业务情况和法规标准进行对比分析。

#### 典型问题示例
- "A单位的防火墙配置是否符合等保三级要求？"
- "B公司的访问控制措施满足GB/T 22239-2019的哪些条款？"
- "C机构的网络隔离方案与等保标准有什么差距？"

#### 实际处理流程

**阶段1：智能路由判断**
1. 调用`LLMIntentRouter`判断查询意图
   - 文件：[domain/strategies/llm_intent_router.py](../domain/strategies/llm_intent_router.py)
   - 支持决策：`"neo4j"` / `"es"` / `"hybrid"` / `"none"`
2. 流式输出路由思考过程（包裹在`<think>`标签）
3. 返回路由决策和置信度

**阶段2：Neo4j业务查询**（当决策为hybrid或neo4j）
1. 调用`Neo4jQueryService.query_stream()`执行图数据库查询
   - 文件：[domain/services/neo4j_query_service.py](../domain/services/neo4j_query_service.py)
2. **6个执行阶段**：
   - Phase 1: LLM意图识别（流式输出）
   - Phase 2: ES示例匹配（从Cypher示例库检索）
   - Phase 3: 批量Cypher生成（流式输出）
   - Phase 4: Neo4j查询执行
   - Phase 5: LLM摘要生成（流式输出）
   - Phase 6: 知识输出（结构化）
3. 过滤`<think>`标签，提取`<data>`内容
4. 将Neo4j结果保存为`neo4j_data_content`

**阶段3：问题增强**（仅hybrid模式）
```python
enhanced_question = question + "以下是检索到的具体业务信息：" + neo4j_data_content
```

**阶段4：ES法规标准查询**（当决策为hybrid或es）
1. 调用`ESQueryService.query_stream()`执行法规检索
   - 文件：[domain/services/es_query_service.py](../domain/services/es_query_service.py)
2. **4个执行阶段**：
   - Phase 1: LLM意图解析（流式输出思考过程）
   - Phase 2: ES混合检索（BM25 + 向量）
   - Phase 3: LLM答案生成（流式输出）
   - Phase 4: 知识匹配（Top 2相关原文）
3. 过滤重复的`<think>`标签
4. 输出最终答案和引用知识

**阶段5：知识引用输出**
1. 从LLM完整回答中提取关键内容
2. 匹配相关法规标准原文（最多2条）
3. 输出到`<knowledge>`标签（`message_type=3`）

#### 流式输出格式（SSE）

```
data: {"content": "<think>开始智能路由分析...\n", "message_type": 1}

data: {"content": "判断需要业务图谱查询\n", "message_type": 1}

data: {"content": "</think>\n", "message_type": 1}

data: {"content": "现在开始业务知识图谱检索\n", "message_type": 1}

data: {"content": "<think>开始意图识别...\n", "message_type": 1}

data: {"content": "<data>A单位部署了XXX防火墙...\n", "message_type": 2}

data: {"content": "</data>\n", "message_type": 2}

data: {"content": "现在开始法规标准检索\n", "message_type": 1}

data: {"content": "<think>开始对用户的提问进行深入解析...\n", "message_type": 1}

data: {"content": "<data>根据等保三级要求，防火墙需满足...\n", "message_type": 2}

data: {"content": "</data>\n", "message_type": 2}

data: {"content": "{\"title\":\"相关的标准规范原文内容\",\"table_list\":[\"【GB/T 22239-2019】...\"]}", "message_type": 3}
```

#### 消息类型说明
- `message_type=1`: 思考过程（think）
- `message_type=2`: 答案内容（data）
- `message_type=3`: 知识引用（knowledge）
- `message_type=4`: 错误信息（error）

---

### 场景2：纯业务查询（scene_id=2）

#### 适用情况
用户仅关心业务情况，不涉及法规标准。

#### 典型问题示例
- "某单位的网络拓扑结构是什么？"
- "A公司部署了哪些安全产品？"
- "B机构的防火墙由哪家集成商负责？"

#### 实际处理流程

**完整流程**
1. 调用`Neo4jQueryService.query_stream()`
2. 执行完整的6阶段Neo4j查询
3. 流式输出思考过程和查询结果
4. 返回结构化知识（Cypher查询结果）

**关键特点**
- 无需调用ES
- 输出格式与混合查询的Neo4j阶段相同
- 支持复杂图谱关系查询（多跳路径、聚合分析）

---

### 场景3：纯法规查询（scene_id=3）

#### 适用情况
用户仅关心法规标准，不涉及具体业务。

#### 典型问题示例
- "等保三级对访问控制有什么要求？"
- "GB/T 22239-2019第8.1.3条款的内容是什么？"
- "网络安全法对数据分类分级有哪些规定？"

#### 实际处理流程

**完整流程**
1. 调用`ESQueryService.query_stream()`
2. 执行完整的4阶段ES查询
3. 流式输出思考过程和答案
4. 返回相关法规标准原文引用（Top 2）

**关键特点**
- 无需调用Neo4j
- 支持三种检索策略：
  - `keyword_search`: BM25权重0.8，向量权重0.2
  - `semantic_search`: BM25权重0.2，向量权重0.8
  - `hybrid_search`: BM25权重0.6，向量权重0.4（默认）

---

## 三、技术要求

### 3.1 核心技术栈

**后端框架**
- FastAPI: 现代化异步Web框架
- Pydantic: 数据验证和配置管理
- Asyncio: 异步I/O和并发控制

**知识库**
- Elasticsearch 8.x+: 法规标准全文检索
- Neo4j 4.x+: 业务关系图谱
- Redis 6.x+: 会话缓存和消息存储
- MySQL 8.x+: 会话持久化

**AI能力**
- LLM: 通过OpenAI兼容接口调用（支持DeepSeek、Qwen等）
- 功能：
  - 智能路由判断
  - 意图解析
  - Cypher生成
  - 答案生成
  - 知识匹配

### 3.2 架构要求

**Clean Architecture（DDD）四层架构**

```
┌─────────────────────────────────────┐
│         API Layer (FastAPI)         │  ← HTTP接口、依赖注入
├─────────────────────────────────────┤
│     Application Layer (Services)    │  ← 业务编排、流程控制
├─────────────────────────────────────┤
│      Domain Layer (Core Logic)      │  ← 领域服务、策略、实体
│  - Neo4jQueryService (630 lines)    │
│  - ESQueryService (620 lines)       │
│  - LLMIntentRouter                  │
├─────────────────────────────────────┤
│  Infrastructure Layer (Clients)     │  ← 外部服务客户端
│  - LLMClient, ESClient              │
│  - Neo4jClient, RedisClient         │
│  - MySQLClient                      │
├─────────────────────────────────────┤
│      Core Layer (Config/Utils)      │  ← 配置、日志、工具
└─────────────────────────────────────┘
```

**依赖注入原则**
- 所有服务通过构造器注入依赖
- 使用单例模式管理全局客户端
- 依赖方向：外层→内层，禁止反向依赖

**完全独立实现**
- ✅ 0个old代码导入
- ✅ 所有核心逻辑100%重写
- ✅ 易于测试和扩展

### 3.3 性能要求

**响应时间**
- 首字节响应（TTFB）：< 2秒
- 完整答案生成：< 30秒
- ES检索：< 1秒
- Neo4j查询：< 3秒

**并发能力**
- 支持100+并发用户
- 使用异步I/O避免阻塞
- Redis缓存降低数据库压力

**流式输出**
- 实时推送思考过程和答案内容
- 用户感知延迟 < 500ms
- SSE长连接稳定性 > 99%

### 3.4 数据要求

**法规标准知识库（ES）**
- 索引名称：`kb_vector_store`（可配置）
- 文档字段：
  - `content`: 条款内容（全文+向量）
  - `source_standard`: 标准名称（如"GB/T 22239-2019"）
  - `title`: 条款标题
  - `applicability_level`: 等级（第一级/第二级/第三级/第四级）
- 索引规模：10,000+条款

**业务图谱知识库（Neo4j）**
- 节点类型：
  - `单位`: 组织单位（name, type, address）
  - `网络`: 网络节点（name, type, ip_range）
  - `系统`: 系统节点（name, type, version）
  - `设备`: 设备节点（name, type, model, ip）
  - `安全产品`: 安全产品（name, type, vendor）
  - `集成商`: 集成商（name, contact）
- 关系类型：
  - `拥有`: 单位→网络/系统/设备
  - `包含`: 网络→系统/设备
  - `部署`: 网络/系统→安全产品
  - `集成`: 集成商→单位

**Cypher示例库（ES）**
- 索引名称：`qa_system`（默认，可通过`ES_CYPHER_INDEX`配置）
- 用途：为Neo4j意图提供Cypher查询示例
- 文档字段：
  - `intent`: 意图描述
  - `cypher`: 对应的Cypher查询语句
  - `example`: 示例问题

---

## 四、接口规范

### 4.1 核心接口

#### 流式问答接口（主要接口）

**端点**: `POST /api/v1/chat/stream`

**请求参数**:
```json
{
  "user_id": "user123",
  "session_id": "session456",
  "query": "A单位的防火墙配置是否符合等保三级要求？",
  "scene_id": 1
}
```

**场景ID说明**:
- `1`: 混合查询（Hybrid: Neo4j + ES）
- `2`: 纯业务查询（Neo4j Only）
- `3`: 纯法规查询（ES Only）

**响应格式**: SSE流式输出
```
Content-Type: text/event-stream
Cache-Control: no-cache
Connection: keep-alive

data: {"content": "<think>...", "message_type": 1}

data: {"content": "<data>...", "message_type": 2}

data: {"content": "{...}", "message_type": 3}
```

#### 会话管理接口

**创建会话**: `POST /api/v1/sessions`
```json
{
  "user_id": "user123",
  "title": "等保合规咨询",
  "scene_id": 1
}
```

**获取会话**: `GET /api/v1/sessions/{session_id}`

**获取历史**: `GET /api/v1/sessions/{session_id}/messages`

**删除会话**: `DELETE /api/v1/sessions/{session_id}`

---

## 五、配置说明

### 5.1 环境变量配置

系统通过`.env`文件进行配置，核心配置项如下：

**LLM配置**
```env
LLM_BASE_URL=https://dashscope.aliyuncs.com/compatible-mode/v1
LLM_API_KEY=sk-xxx
LLM_CHAT_MODEL=deepseek-v3
LLM_INTENT_MODEL=deepseek-v3
LLM_CHAT_MAX_TOKENS=4096
LLM_CHAT_TEMPERATURE=0.7
```

**Elasticsearch配置**
```env
ES_HOST=localhost
ES_PORT=9200
ES_USERNAME=elastic
ES_PASSWORD=password01
ES_KNOWLEDGE_INDEX=kb_vector_store
ES_CONVERSATION_INDEX=conversation_history
ES_CYPHER_INDEX=qa_system
```

**Neo4j配置**
```env
NEO4J_URI=bolt://localhost:7687
NEO4J_USER=neo4j
NEO4J_PASSWORD=password
NEO4J_DATABASE=neo4j
```

**Redis配置**
```env
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=
REDIS_DB=0
REDIS_TTL=86400
```

**MySQL配置**
```env
MYSQL_HOST=localhost
MYSQL_PORT=3306
MYSQL_USER=root
MYSQL_PASSWORD=password
MYSQL_DATABASE=qa_system
```

### 5.2 系统提示词配置

**路由提示词**: [core/config/prompts.py](../core/config/prompts.py) - `llm_router_prompt`
- 决策：neo4j / es / hybrid / none
- 输出格式：JSON (decision, reasoning, confidence)

**Neo4j意图提示词**: 内置于`Neo4jQueryService`
- 图数据库schema定义
- Cypher生成指导

**ES意图提示词**: 内置于`ESQueryService`
- 法规标准解析规则
- 实体识别（要求项、资产对象、等级）

**答案生成提示词**: [core/config/prompts.py](../core/config/prompts.py) - `system_prompt`
- 专业、准确、简洁
- 引用具体标准条款

### 5.3 外部依赖

**必需的外部服务**：
1. **大语言模型服务**
   - 默认：通过OpenAI兼容接口调用
   - 配置：[core/config/settings.py](../core/config/settings.py) - LLMSettings
   - 支持：DeepSeek、Qwen、GLM等

2. **Elasticsearch服务**
   - 版本：8.x+
   - 索引：`kb_vector_store`（必需）、`qa_system`（Neo4j场景必需）

3. **Neo4j服务**（可选）
   - 版本：4.x+
   - 说明：scene_id=1或2时必需

4. **Redis服务**（可选）
   - 版本：6.x+
   - 说明：用于会话缓存，可选

5. **MySQL服务**（可选）
   - 版本：8.x+
   - 说明：用于会话持久化，可选

---

## 六、用户角色与权限

### 6.1 用户角色

**普通用户**
- 查询法规标准
- 查询业务情况
- 查看历史会话

**管理员**
- 所有普通用户权限
- 管理知识库
- 查看系统日志
- 配置系统参数

### 6.2 权限设计

当前版本为单用户系统，通过`user_id`标识不同用户，未实现细粒度权限控制。

**未来扩展方向**：
- RBAC权限模型
- 数据访问隔离
- 审计日志

---

## 七、质量要求

### 7.1 功能完整性

**✅ 已实现**
- 三种场景完整实现（hybrid/neo4j/es）
- 智能路由判断（LLMIntentRouter）
- Neo4j 6阶段查询（完全独立实现）
- ES 4阶段查询（完全独立实现）
- 流式输出（SSE）
- 会话管理
- 消息历史
- 依赖注入
- 配置管理

**⏳ 待优化**
- 向量检索性能优化
- 缓存策略优化
- 错误重试机制
- 单元测试覆盖

### 7.2 代码质量

**✅ 架构标准**
- Clean Architecture（DDD）
- 依赖注入
- 单一职责原则
- 开闭原则

**✅ 代码标准**
- 类型注解（Type Hints）
- 文档字符串（Docstrings）
- 错误处理
- 日志记录

**✅ 独立性**
- 0个old代码导入
- 所有核心服务100%重写
- 易于测试和扩展

### 7.3 可维护性

**文档完整**
- ✅ 需求文档（本文档）
- ⏳ 架构设计文档
- ⏳ 详细设计文档
- ⏳ 数据库设计文档
- ⏳ 部署运维文档

**代码可读性**
- 清晰的模块划分
- 完整的类型注解
- 详细的注释说明

**易于扩展**
- 新增查询场景仅需实现Service接口
- 新增知识源仅需实现Client接口
- 配置化系统提示词

---

## 八、非功能性需求

### 8.1 可用性
- 系统可用性：> 99%
- 故障恢复时间：< 5分钟

### 8.2 安全性
- API鉴权（可选）
- 敏感信息加密
- SQL注入防护
- XSS防护

### 8.3 可观测性
- 结构化日志（[core/logging.py](../core/logging.py)）
- 错误追踪
- 性能监控（可选）

### 8.4 兼容性
- Python 3.9+
- 跨平台支持（Windows/Linux/MacOS）

---

## 九、版本历史

**v4.0 (2025-12-26)**
- ✅ 完全移除old代码依赖
- ✅ Neo4jQueryService完整重写（630行）
- ✅ ESQueryService完整重写（620行）
- ✅ LegacyStreamingService简化（-149行）
- ✅ 依赖注入系统完善
- ✅ 文档全面更新

**v3.0 (2025-12-25)**
- ✅ Clean Architecture架构重构
- ✅ 三种场景完整实现
- ✅ LLMIntentRouter智能路由
- ⚠️ 仍依赖部分old代码

**v2.0 (2025-12-20)**
- 初始架构设计
- 基本功能实现

---

## 十、总结

本系统是一个**完全独立实现**的网络安全智能问答系统，采用Clean Architecture架构，支持三种查询场景（混合/业务/法规），通过依赖注入实现松耦合，所有核心服务（Neo4jQueryService 630行、ESQueryService 620行）100%重写，0依赖外部old代码，易于测试、扩展和维护。

**核心优势**：
1. 完全独立：无外部代码依赖
2. 架构清晰：DDD四层架构
3. 流式输出：实时响应用户
4. 配置灵活：.env环境变量
5. 易于扩展：依赖注入+接口设计

**适用场景**：
- 网络安全合规咨询
- 等保测评辅助
- 法规标准查询
- 业务配置查询
