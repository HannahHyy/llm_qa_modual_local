# 网络安全智能问答系统 - 需求文档

**文档版本**: v2.0
**编写日期**: 2025-12-25
**负责人**: 技术架构组
**状态**: 正式版

---

## 一、系统概述

本系统是一个专注于**网络安全等级保护合规咨询**的智能问答系统，通过整合多源知识库和大语言模型技术，为用户提供精准的合规分析和业务查询服务。

### 核心价值

为网络安全从业人员提供三大核心能力：
1. **法规标准查询**：快速检索并理解等保、网安法等法规标准的具体要求
2. **业务情况查询**：查询具体单位的网络架构、安全产品、配置信息等业务数据
3. **合规对比分析**：将具体业务情况与法规标准要求进行智能对比，识别合规差距

### 知识来源

系统整合两大知识库：

**法规标准知识库（ES）**
- 内容：网络安全法、等保条例、GB/T标准、行业规范等权威文档
- 技术：Elasticsearch向量检索 + 关键词检索
- 规模：数万条法规条款和标准要求

**业务图谱知识库（Neo4j）**
- 内容：具体单位的网络架构、系统配置、安全产品部署、责任关系等
- 技术：Neo4j图数据库 + Cypher查询
- 特点：支持关系查询和路径分析

---

## 二、核心业务场景

系统通过scene_id参数区分三种查询场景，每种场景对应不同的业务需求。

### 场景1：混合查询（scene_id=1）

**适用情况**：用户问题需要结合业务情况和法规标准进行对比分析

**典型问题示例**：
- "A单位的防火墙配置是否符合等保三级要求？"
- "B公司的访问控制措施满足GB/T 22239-2019的哪些条款？"
- "C机构的网络隔离方案与等保标准有什么差距？"

**处理流程说明**：
1. 系统首先使用大语言模型分析问题，判断需要查询的知识源
2. 如果判断为混合查询，先查询业务图谱获取具体业务信息
3. 将获取的业务信息与原问题合并，形成增强问题
4. 使用增强问题查询法规标准库，获取相关要求
5. 综合生成对比分析回答

**输出内容**：
- 思考过程：展示路由判断和查询过程
- 业务信息：检索到的具体业务数据
- 法规要求：相关的标准条款
- 对比分析：综合分析结论
- 原文引用：匹配的法规标准原文

### 场景2：业务图谱查询（scene_id=2）

**适用情况**：用户只需要查询具体业务数据，不涉及法规标准

**典型问题示例**：
- "A单位的集成商是谁？"
- "B公司部署了哪些安全产品？"
- "C机构的网络管理员是谁？"
- "查询某系统的防火墙品牌和型号"

**处理流程说明**：
1. 解析用户意图，识别查询的业务实体和关系
2. 基于意图和ES中的Cypher示例库，生成Neo4j查询语句
3. 执行图数据库查询，获取业务数据
4. 生成业务数据摘要回答
5. 返回结构化的业务信息

**输出内容**：
- 思考过程：意图解析和Cypher生成过程
- 业务数据：查询结果摘要
- 图谱信息：相关实体和关系的JSON格式数据

### 场景3：法规标准查询（scene_id=3）

**适用情况**：用户只需要了解法规标准内容，不涉及具体业务

**典型问题示例**：
- "什么是等保三级？"
- "GB/T 22239-2019对身份鉴别有哪些要求？"
- "网络安全法第二十一条的内容是什么？"
- "等保测评的基本流程是怎样的？"

**处理流程说明**：
1. 解析用户意图，提取关键查询条件
2. 在法规标准知识库中检索相关文档
3. 使用大语言模型基于检索结果生成回答
4. 从回答中识别提到的法规标准
5. 匹配并返回原文内容

**输出内容**：
- 思考过程：意图解析过程
- 回答内容：基于知识库的回答
- 原文引用：相关法规标准的原文片段

---

## 三、功能需求

### 3.1 智能意图路由

**需求描述**：
系统能够自动分析用户问题的特征，判断应该使用哪个知识源或组合使用多个知识源。

**路由类型**：
- **neo4j**: 问题涉及具体业务实体（单位名、系统名、设备型号等）
- **es**: 问题涉及法规条款、标准要求、规范内容
- **hybrid**: 问题需要对比业务情况与法规要求
- **none**: 问候语、闲聊等不需要检索知识库的简单问题

**路由机制**：
- 使用大语言模型分析问题特征和历史对话上下文
- 采用JSON格式输出决策结果，包含决策类型、理由和置信度
- 支持重试机制，最多3次尝试确保路由准确性
- 如果JSON解析失败，使用关键词匹配降级策略

**准确性要求**：
- 路由准确率应 ≥ 90%
- 混合查询的识别准确率应 ≥ 85%
- 支持流式输出路由推理过程，增强可解释性

### 3.2 流式输出

**需求描述**：
系统采用服务器发送事件（SSE）技术实现流式输出，让用户实时看到系统的处理过程和回答内容。

**输出类型定义**：
- **think（message_type=1）**: 思考过程，包括意图解析、路由判断、Cypher生成等
- **data（message_type=2）**: 最终生成的回答内容
- **knowledge（message_type=3）**: 匹配的法规标准原文（仅ES查询场景）
- **error（message_type=4）**: 错误信息提示

**输出格式规范**：
- SSE格式：`data:{JSON字符串}\n\n`
- JSON结构：`{"content": "内容", "message_type": 数字}`
- 编码：UTF-8，确保中文正确显示
- 延迟控制：每次输出间隔10ms，确保流式效果

**标签系统**：
- `<think>...</think>`: 包裹思考过程内容
- `<data>...</data>`: 包裹最终回答内容
- `<knowledge>...</knowledge>`: 包裹知识原文内容

**用户体验要求**：
- 首字延迟 < 2秒
- 流式输出流畅，无明显卡顿
- 思考过程清晰可读，便于用户理解系统决策

### 3.3 多轮对话

**需求描述**：
系统支持基于历史上下文的多轮对话，能够理解追问、指代消解、话题延续等对话行为。

**上下文管理策略**：
- 保留历史消息：存储所有用户和助手的对话消息
- 上下文窗口：传递给LLM时只使用最近2轮对话
- 内容过滤：从历史消息中移除思考过程和知识原文，只保留核心回答
- 长度截断：单条消息最长8000字符，总上下文最长98304字符

**会话管理**：
- 每个用户可创建多个独立会话
- 会话支持自定义命名
- 会话列表支持分页查询
- 会话可以删除和清空

**消息持久化**：
- 双存储架构：Redis（快速访问）+ Elasticsearch（持久化 + 全文检索）
- Redis存储最近N条消息，超出后自动清理
- ES存储完整历史，支持按会话ID、用户ID、时间范围查询
- 消息包含元数据：timestamp、user_id、session_id、role

### 3.4 知识匹配

**需求描述**：
在法规标准查询场景下，系统能够从LLM生成的回答中提取关键信息，匹配最相关的原文片段。

**匹配流程**：
1. LLM生成回答后，将回答文本发送给另一个LLM
2. LLM分析回答，识别其中提到的法规标准名称和章节
3. 从ES检索结果中查找对应的原文片段
4. 按相关性排序，选取最相关的2条
5. 以结构化JSON格式返回给前端

**返回信息结构**：
- 标准名称和编号
- 章节标题层级
- 原文内容片段
- 适用等级标识
- 检索路径说明

**准确性要求**：
- 匹配准确率 ≥ 80%
- 原文片段应包含完整语义
- 支持多标准混合匹配

---

## 四、非功能需求

### 4.1 性能要求

**响应时间指标**：
- 流式输出首字延迟：< 2秒
- 意图识别完成时间：< 5秒
- 单次完整查询时间：< 30秒
- 会话列表查询：< 500ms

**并发处理能力**：
- 支持100+用户同时在线
- 单个会话支持实时流式输出
- 多个会话之间互不影响

**资源使用要求**：
- 内存使用：每个活跃会话 < 50MB
- CPU使用：LLM调用时短暂高峰可接受
- 网络带宽：流式输出平稳，无突发流量

### 4.2 可用性要求

**系统可用性指标**：
- 核心查询功能可用性 ≥ 99.5%
- 支持优雅降级：Neo4j不可用时ES查询仍可用
- 自动重试：LLM调用失败自动重试3次
- 超时保护：单次LLM调用超时30秒自动终止

**错误处理要求**：
- 所有错误都有明确的用户提示
- 错误信息友好，不暴露技术细节
- 严重错误自动记录日志，便于排查
- 支持错误恢复，不影响后续请求

**容错能力**：
- Neo4j服务不可用：自动降级为ES查询
- ES服务不可用：返回友好提示
- LLM服务不可用：返回降级回答或错误提示
- Redis不可用：降级使用ES查询历史

### 4.3 可维护性要求

**配置管理**：
- 所有提示词支持通过配置文件调整
- 所有LLM参数（模型、温度、token数）可配置
- 配置文件采用.env格式，支持环境变量覆盖
- 配置变更后重启生效，部分配置支持热更新

**代码质量**：
- 遵循Clean Architecture分层架构原则
- 高内聚低耦合设计，单一职责
- 依赖注入，便于单元测试
- 关键算法逻辑与验证过的旧系统保持一致

**日志与监控**：
- 关键操作记录详细日志（意图解析、知识检索、LLM调用）
- 支持按会话ID追踪完整处理流程
- 错误日志包含足够上下文（用户ID、会话ID、问题内容）
- 性能指标记录（响应时间、Token消耗）

**文档完整性**：
- 需求文档、架构文档、详细设计文档齐全
- API文档包含完整的接口说明和示例
- 开发指南帮助新人快速上手
- 配置说明清晰，参数含义明确

### 4.4 安全性要求

**数据安全**：
- 会话数据支持加密存储（预留）
- 用户数据按用户ID隔离
- 敏感配置（API密钥）不得硬编码在代码中
- 日志中不记录敏感信息（密码、密钥）

**访问控制**：
- API接口支持用户身份验证（预留）
- 不同用户只能访问自己的会话和消息
- 管理接口需要特殊权限（预留）

**输入验证**：
- 用户输入长度限制，防止超长输入攻击
- 特殊字符过滤，防止注入攻击
- 会话ID格式验证

---

## 五、系统边界

### 5.1 系统包含的功能

**核心功能**：
- 智能问答服务（三种场景）
- 知识库检索（ES + Neo4j）
- 多轮对话管理
- 流式输出
- 消息持久化

**辅助功能**：
- 会话管理（创建、查询、删除）
- 历史消息查询
- 健康检查接口

### 5.2 系统不包含的功能

**外部依赖**：
- 用户认证授权（由外部系统提供或预留）
- 知识库内容管理（使用独立的管理工具）
- 前端界面（系统仅提供API接口）

**未来规划**：
- 数据统计分析（预留）
- 用户反馈收集（预留）
- A/B测试框架（预留）
- 多模型并行（预留）

---

## 六、约束条件

### 技术约束
- Python 3.9+
- 大语言模型：通过API调用，支持OpenAI兼容接口
- Elasticsearch 7.x+
- Neo4j 4.x+
- Redis 6.x+

### 业务约束
- 主要服务于网络安全等级保护领域
- 知识库内容由专业团队维护
- 回答基于知识库内容，不生成虚假信息

### 资源约束
- LLM API调用有成本，需控制Token消耗
- 并发量受服务器资源限制
- 知识库规模受ES和Neo4j容量限制

---

## 七、术语表

| 术语 | 全称/说明 |
|------|----------|
| 等保 | 网络安全等级保护制度 |
| GB/T 22239 | 《信息安全技术 网络安全等级保护基本要求》国家标准 |
| ES | Elasticsearch，分布式搜索引擎 |
| Neo4j | 图数据库，用于存储和查询关系数据 |
| Cypher | Neo4j数据库的查询语言 |
| LLM | Large Language Model，大语言模型 |
| SSE | Server-Sent Events，服务器发送事件，用于实现流式输出 |
| scene_id | 场景标识符：1=混合查询，2=仅Neo4j，3=仅ES |
| message_type | 消息类型：1=think，2=data，3=knowledge，4=error |
| Clean Architecture | 整洁架构，一种软件架构模式，强调分层和依赖倒置 |

---

## 八、验收标准

### 功能验收
- ✅ 三种场景查询全部正常工作
- ✅ 路由准确率达标（≥90%）
- ✅ 流式输出流畅无卡顿
- ✅ 多轮对话上下文正确
- ✅ 知识匹配准确率达标（≥80%）

### 性能验收
- ✅ 首字延迟 < 2秒
- ✅ 完整查询 < 30秒
- ✅ 支持100+并发用户

### 质量验收
- ✅ 核心功能无P0/P1级bug
- ✅ 代码通过Clean Architecture审查
- ✅ 算法逻辑与旧系统完全一致
- ✅ 文档完整准确

---

**文档状态**: ✅ 已完成
**下一版本计划**: 根据实际使用反馈优化
**联系人**: 技术架构组
