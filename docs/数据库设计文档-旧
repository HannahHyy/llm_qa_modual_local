# 架构设计文档: 基于向量检索和图检索的网络业务情况和法规标准智能问答系统。
## 版本：1.0
## 更新日期：2025-12-18


## 1. 数据架构
本系统的数据架构采用多组件协同的设计模式，根据不同数据的访问模式和使用场景，选择合适的存储技术，实现高性能、高可靠和可扩展性。

### 核心数据存储

#### 1.1 Elasticsearch(ES): 统一检索引擎 - 向量与全文索引设计
为了实现高效的语义搜索和混合查询，我们将采用 Elasticsearch (ES) 作为核心检索层。
ES 作为统一的数据存储与检索引擎，通过创建独立的索引来逻辑隔离不同类型的数据。
作用：全文搜索、向量相似度匹配和混合查询。

##### (1) 索引一：`kb_vector_store` (法规知识向量库)

**用途**：存储所有法规条文的原始内容、元数据及其向量表示，是回答问题的主要知识来源。
**数据来源**：dbexcel/测评要求.csv + dbexcel/基本要求.csv

**文档结构 (Mapping)**：

```json
{
  "序号": { "type": "keyword" },
  "内容（Content）": { "type": "text" },
  "标准出处(source_standard)": { "type": "keyword" },
  "标识(identifier)": { "type": "keyword" },
  "对应要求项（requirement_item）": { "type": "keyword" },
  "一级标题（section_level1）": { "type": "keyword" },
  "二级标题（section_level2）": { "type": "keyword" },
  "三级标题（section_level3）": { "type": "keyword" },
  "四级标题（section_level4）": { "type": "keyword" },
  "五级标题（section_level5）": { "type": "keyword" },
  "适用级别（applicability_level）": { "type": "keyword" },
  "clause_key_en": {"type": "keyword"},         # 条款唯一标识符
  "requirement_item_en": {"type": "keyword"},   # 要求项唯一标识符
  "applicability_level_en": {"type": "keyword"},# 使用级别唯一标识符
  "content_embedding": {
    "type": "dense_vector",
    "dims": 1024, (bge-large-zh)
    "index": true,
    "similarity": "cosine"
  }
}
```

**构建流程**：

1.  将每一条 `Content` 记录视为一个独立的知识单元。
2.  使用 Embedding 模型将 `Content` 文本转换为固定长度的向量。
3.  将包含原始文本、元数据和向量的完整文档写入 ES 的 `kb_vector_store` 索引。

##### (2) 索引二：`user_memory` (用户长期记忆库)

**用途**：存储经过提炼的用户历史对话摘要，用于个性化服务和避免重复错误。

**文档结构 (Mapping)**：

```json
{
  "user_id": { "type": "keyword" },
  "session_id": { "type": "keyword" },
  "query_text": { "type": "text" },
  "query_embedding": {
    "type": "dense_vector",
    "dims": 1024,
    "index": true,
    "similarity": "cosine"
  },
  "summary_text": { "type": "text" },
  "assistant_response": { "type": "text" },
  "satisfaction_score": { "type": "integer" },
  "timestamp": { "type": "date" }
}
```

**构建流程**：

1.  在每次会话结束后，由后台任务对 `user_id` 对应的对话历史进行摘要提炼。
2.  计算用户原始提问 `query_text` 的向量。
3.  将摘要信息连同 `user_id`、向量和时间戳存入 `user_memory` 索引。

##### (3) 索引三：`conversation_history` (会话历史索引表)

**用途**：存储会话历史记录，支持多轮对话上下文管理。采用Redis缓存优先、ES持久化备用的双层存储架构。

**文档结构 (Mapping)**：

```json
{
  "user_id": { "type": "keyword" },
  "session_id": { "type": "keyword" },
  "message_id": { "type": "keyword" },
  "role": { "type": "keyword" },
  "content": { "type": "text" },
  "timestamp": { "type": "date" },
  "message_order": { "type": "integer" }
}
```

**上下文记录获取流程**：

1. **Redis缓存优先**：后端根据 `(user_id, session_id)` 从Redis缓存 `chat:{user_id}:{session_id}` 中获取上下文记录（history_msgs）
2. **ES备用查询**：若Redis缓存未命中，则查询ES会话历史索引表 `conversation_history`，使用 `session_id` 获取该会话的全部或部分历史记录
3. **缓存回填**：从ES获取到历史记录后，将其重新加载到Redis缓存中，确保下次快速访问，符合标准的缓存策略

**数据持久化流程**：

1. 在每次会话交互时，实时更新Redis缓存中的对话记录
2. 定期或在会话结束后，将Redis中的对话数据同步到ES进行持久化存储
3. 计算用户原始提问 `query_text` 的向量嵌入
4. 将完整的会话信息连同用户ID、会话ID、向量和时间戳存入ES索引


#### 1.2 Neo4j：网络业务知识图谱构建

认真参考neo4j_import



#### 1.3 MySQL:结构化元数据管理
作为持久化的关系型数据库，存储系统运行所需的结构化配置和元数据，保证数据的一致性和事务完整性。
##### 主要存储内容：
**用户表 (users)**:
*   user_id (主键): 用户唯一标识符。
*   username, email, created_at 等基础信息（可选，取决于业务需求）。
**会话表 (sessions)**:
*   session_id (主键): 会话唯一标识符 (UUID)。
*   user_id (外键): 关联到用户。
*   name: 会话名称（可自定义）。
*   created_at: 会话创建时间。
*   updated_at: 会话最后更新时间。
*   is_active: 会话状态标记。
**角色与职责**：
*   持久化中心：作为会话和用户信息的“唯一事实来源”(Source of Truth)。
*   Redis 同步源：当创建/删除会话时，操作先在 MySQL 中完成，然后同步更新 Redis 缓存，确保数据一致性。
*   支持后台任务：为生成报表、用户统计等离线任务提供稳定的数据接口。

#### 1.4 Redis：多轮对话上下文缓存 - 短期上下文记忆

作为内存中的高速数据存储，专为处理实时、高并发的读写请求而设计，是保障流式对话体验的关键组件。

- 键与数据结构
  - 会话元数据（Hash）
    - Key：chat:{user_id}:sessions
    - Field：{session_id}
    - Value：JSON 字符串，包含 name、created_at
  - 会话消息列表（List）
    - Key：chat:{user_id}:session:{session_id}:messages
    - Value（每个元素为 JSON 序列化的消息）：
      ```json
      { "role": "user | assistant", "content": "<消息内容>", "ts": "ISO-8601 时间戳" }
      ```
- 示例
  - Key（消息列表）：chat:u1:session:sess_abc123:messages
  - Value（List 片段）：
    ```json
    [
      { "role": "user", "content": "什么是物理访问控制？", "ts": "2023-10-27T10:00:00Z" },
      { "role": "assistant", "content": "物理访问控制是指...", "ts": "2023-10-27T10:00:05Z" }
    ]
    ```
- 角色与职责
  - 短期记忆：存储当前活跃会话的完整上下文，支持多轮对话。
  - 低延迟访问：内存读写极快，保障 /api/chat/stream 毫秒级响应。
  - 降压核心库：避免频繁访问 MySQL/ES 以获取完整历史。
  - 实现细节：读取消息时会取全部记录，但在构造 Prompt 时仅使用最近 20 条参与生成回复。

